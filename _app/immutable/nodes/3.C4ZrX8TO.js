import{f as y,a as l,c as re,t as ue,d as xr}from"../chunks/CEbVEvWq.js";import{I as G,J as e,K as a,M as Y,O as Vt,aJ as Qt,u as Re,S as o,T as n,U as i,aI as Pt,Q as M,R as qt,P as ae,af as et,aC as br}from"../chunks/DISrue0C.js";import{s as z}from"../chunks/DHKgQpv7.js";import{i as S}from"../chunks/DqJZiQ1o.js";import{r as ft,s as $r}from"../chunks/eICFcUV5.js";import{s as Er,r as nr}from"../chunks/DeimN4pl.js";import{d as lr,e as mt}from"../chunks/BWz26xft.js";import{p as Mt,b as ea}from"../chunks/CepRIdbm.js";import{C as Nr,T as or,D as ur,a as Dr,u as Rr,d as wr,e as Bt,i as Kt,c as dt,l as ta,s as ra,S as Lr,b as kt,f as Gr,W as Ft,U as aa,R as ir,g as sa,h as Ar,j as na,k as oa,m as ia,n as la,o as ua,p as da,t as ca}from"../chunks/BalJhbXZ.js";import{b as zt,A as va}from"../chunks/CEv-pqVm.js";import{l as yt,g as dr,R as _t}from"../chunks/C2HNWrRp.js";import{g as yr}from"../chunks/DB_aGq-d.js";const pa=!0,As=Object.freeze(Object.defineProperty({__proto__:null,prerender:pa},Symbol.toStringTag,{value:"Module"}));var Se=(ce=>(ce.IDLE="IDLE",ce.LOADING="LOADING",ce.LOADED="LOADED",ce.ERROR="ERROR",ce.SAVING="SAVING",ce))(Se||{});const At="__all__";class ga{#e=G(null);get seriesId(){return e(this.#e)}set seriesId(t){a(this.#e,t,!0)}#t=G(Y([]));get chapters(){return e(this.#t)}set chapters(t){a(this.#t,t,!0)}#r=G(!1);get isLoading(){return e(this.#r)}set isLoading(t){a(this.#r,t,!0)}#a=G(null);get loadError(){return e(this.#a)}set loadError(t){a(this.#a,t,!0)}#s=G(!1);get isSavingAll(){return e(this.#s)}set isSavingAll(t){a(this.#s,t,!0)}#n=G(null);get saveProgress(){return e(this.#n)}set saveProgress(t){a(this.#n,t,!0)}#o=G("IDLE");get processingStep(){return e(this.#o)}set processingStep(t){a(this.#o,t,!0)}#i=G(0);get filteredChaptersCount(){return e(this.#i)}set filteredChaptersCount(t){a(this.#i,t,!0)}#l=G(!1);get permissionOverride(){return e(this.#l)}set permissionOverride(t){a(this.#l,t,!0)}#u=G(At);get selectedLanguageFilter(){return e(this.#u)}set selectedLanguageFilter(t){a(this.#u,t,!0)}reset(){this.seriesId=null,this.chapters=[],this.isLoading=!1,this.loadError=null,this.isSavingAll=!1,this.saveProgress=null}getModifiedChapters(){return this.chapters.filter(t=>t.isModified)}markChapterModified(t){const s=this.chapters.find(d=>d.id===t);s&&(s.isModified=!0,s.saveStatus==="saved"&&(s.saveStatus="pending"))}updateChapterField(t,s,d){const C=this.chapters.find(N=>N.id===t);if(!C)return;let c=d;(s==="title"||s==="volume")&&typeof d=="string"&&d===""&&(c=null),C.modified[s]=c;const A=C.original,B=C.modified,q=A.relationships?.groups,j=q&&Array.isArray(q)?q.map(N=>N.id).sort():[],O=B.groups?[...B.groups].sort():null,H=B.chapter??A.chapter,te=A.chapter,K=B.volume??A.volume,I=A.volume,D=B.title??A.title,f=A.title,_=B.language??A.language,x=A.language;C.isModified=H!==te||K!==I||D!==f||_!==x||JSON.stringify(O)!==JSON.stringify(j),C.isModified&&C.saveStatus==="saved"&&(C.saveStatus="pending")}getChapterUpdateData(t){const s=t.original,d=t.modified,C=s.relationships?.groups,c=C&&Array.isArray(C)?C.map(A=>A.id):[];return{chapter:d.chapter??s.chapter,volume:d.volume!==void 0?d.volume:s.volume,title:d.title!==void 0?d.title:s.title,language:d.language??s.language,version:s.version,groups:d.groups!==void 0?d.groups:c}}resetChapter(t){const s=this.chapters.find(d=>d.id===t);s&&(s.modified={},s.isModified=!1,s.saveStatus="pending",s.error=void 0)}updateChapterSaveStatus(t,s,d){const C=this.chapters.find(c=>c.id===t);C&&(C.saveStatus=s,d!==void 0&&(C.error=d))}updateChapterAfterSave(t,s){const d=this.chapters.find(C=>C.id===t);d&&(d.original=s,d.modified={},d.isModified=!1,d.saveStatus="saved",d.error=void 0)}updateChapterDeleteStatus(t,s,d){const C=this.chapters.find(c=>c.id===t);C&&(C.deleteStatus=s,d!==void 0&&(C.error=d))}removeChapter(t){this.chapters=this.chapters.filter(s=>s.id!==t)}getFilteredChapters(){return this.selectedLanguageFilter===At?this.chapters:this.chapters.filter(t=>(t.modified.language!==void 0?t.modified.language:t.original.language)===this.selectedLanguageFilter)}}var ha=y('<span class="uno-clz4zx">* Modified</span>'),fa=y('<span class="uno-ptr006">Deleting...</span>'),ma=y('<span class="uno-rn7dpy">Deleted</span>'),_a=y('<span class="uno-dubrca">Delete Error</span>'),Sa=y('<span class="uno-ocbf92">Saving...</span>'),Ca=y('<span class="uno-rn7dpy">Saved</span>'),Ia=y('<span class="uno-dubrca">Error</span>'),ba=y('<button type="button" class="uno-mih921">Revert</button>'),Ga=y('<p class="uno-dubrca"> </p>'),Aa=y('<div><div class="uno-ln4tmt"><div class="uno-1akirq"><span class="uno-3pnkic"> </span> <span class="uno-o40rdu"> </span> <!> <!> <div class="uno-mzdrk4"><span class="uno-o40rdu">Vol:</span> <!></div> <div class="uno-mzdrk4"><span class="uno-o40rdu">Ch:</span> <!></div></div> <div class="uno-mzdrk4"><!> <button type="button" class="uno-r3dsj6"><!></button> <button type="button" class="uno-setv31"><!></button></div></div> <div class="uno-mzdrk4"><span class="uno-o40rdu">Title:</span> <div class="uno-b83ayl"><!></div></div> <div class="uno-mzdrk4"><span class="uno-o40rdu">Language:</span> <!></div> <div class="uno-mzdrk4"><span class="uno-o40rdu">Groups:</span> <!></div> <!></div>');function ya(ce,t){Vt(t,!0);let s=Mt(t,"class",3,"");const d=Qt(zt);if(!d)throw new Error("ChapterEditorItem must be used within a component that provides ApiAuthContext context");function C(){if(t.chapter.modified.groups!==void 0)return t.chapter.modified.groups;const u=t.chapter.original.relationships?.groups;return u&&Array.isArray(u)?u.map(g=>g.id):[]}let c=G(Y(new Nr));Re(()=>{e(c).groupIds=C()}),Re(()=>{const u=e(c).groupIds??[],g=[...u].sort(),U=[...C()].sort();JSON.stringify(g)!==JSON.stringify(U)&&t.editorState.updateChapterField(t.chapter.id,"groups",u)}),Re(()=>{const u=C(),w=[...e(c).groupIds??[]].sort(),U=[...u].sort();JSON.stringify(w)!==JSON.stringify(U)&&(e(c).groupIds=u)});function A(u){const g=t.chapter.modified[u];if(g!==void 0)return g;const w=t.chapter.original[u];return w!==void 0?w:null}function B(){const u=t.chapter.modified.language;return u!==void 0?u:t.chapter.original.language}let q=G(Y(A("title")??null)),j=G(Y(A("volume")??null)),O=G(Y(A("chapter")??null)),H=G(Y(B())),te=G(Y(A("title")??null)),K=G(Y(A("volume")??null)),I=G(Y(A("chapter")??null)),D=G(Y(B()));Re(()=>{const u=A("title")??null,g=A("volume")??null,w=A("chapter")??null,U=B();u!==e(q)&&u!==e(te)&&a(q,u,!0),g!==e(j)&&g!==e(K)&&a(j,g,!0),w!==e(O)&&w!==e(I)&&a(O,w,!0),U!==e(H)&&U!==e(D)&&a(H,U,!0)}),Re(()=>{e(q)!==e(te)&&(t.editorState.updateChapterField(t.chapter.id,"title",e(q)),a(te,e(q),!0))}),Re(()=>{e(j)!==e(K)&&(t.editorState.updateChapterField(t.chapter.id,"volume",e(j)),a(K,e(j),!0))}),Re(()=>{e(O)!==e(I)&&(t.editorState.updateChapterField(t.chapter.id,"chapter",e(O)),a(I,e(O),!0))}),Re(()=>{e(H)!==e(D)&&(t.editorState.updateChapterField(t.chapter.id,"language",e(H)),a(D,e(H),!0))});function f(){t.editorState.resetChapter(t.chapter.id);const u=t.chapter.original.title??null,g=t.chapter.original.volume??null,w=t.chapter.original.chapter??null,U=t.chapter.original.language;a(q,u,!0),a(j,g,!0),a(O,w,!0),a(H,U,!0),a(te,u,!0),a(K,g,!0),a(I,w,!0),a(D,U,!0)}async function _(){if(!d.apiToken){t.editorState.updateChapterSaveStatus(t.chapter.id,"error","No API token available");return}t.editorState.updateChapterSaveStatus(t.chapter.id,"saving");try{const u=t.editorState.getChapterUpdateData(t.chapter),g=await Rr(t.chapter.id,u,d.apiToken);t.editorState.updateChapterAfterSave(t.chapter.id,g),setTimeout(()=>{const w=t.editorState.chapters.find(U=>U.id===t.chapter.id);w&&w.saveStatus==="saved"&&!w.isModified&&t.editorState.updateChapterSaveStatus(t.chapter.id,"pending")},2e3)}catch(u){const g=u instanceof Error?u.message:"Failed to save chapter";t.editorState.updateChapterSaveStatus(t.chapter.id,"error",g)}}async function x(){if(!d.apiToken){t.editorState.updateChapterDeleteStatus(t.chapter.id,"error","No API token available");return}if(confirm(`Are you sure you want to delete chapter ${t.chapter.id}? This action cannot be undone.`)){t.editorState.updateChapterDeleteStatus(t.chapter.id,"deleting");try{await wr(t.chapter.id,d.apiToken),t.editorState.updateChapterDeleteStatus(t.chapter.id,"deleted"),setTimeout(()=>{t.editorState.removeChapter(t.chapter.id)},1e3)}catch(u){const g=u instanceof Error?u.message:"Failed to delete chapter";t.editorState.updateChapterDeleteStatus(t.chapter.id,"error",g)}}}var N=Aa(),T=o(N),V=o(T),se=o(V),ct=o(se);n(se);var Ie=i(se,2),Ve=o(Ie);n(Ie);var be=i(Ie,2);{var tt=u=>{var g=ha();l(u,g)};S(be,u=>{t.chapter.isModified&&u(tt)})}var ge=i(be,2);{var rt=u=>{var g=fa();l(u,g)},vt=u=>{var g=re(),w=ae(g);{var U=R=>{var X=ma();l(R,X)},Oe=R=>{var X=re(),xe=ae(X);{var Ct=Te=>{var ot=_a();l(Te,ot)},He=Te=>{var ot=re(),it=ae(ot);{var me=ke=>{var lt=Sa();l(ke,lt)},Je=ke=>{var lt=re(),Ut=ae(lt);{var Zt=We=>{var pt=Ca();l(We,pt)},It=We=>{var pt=re(),jt=ae(pt);{var $t=ut=>{var Rt=Ia();l(ut,Rt)};S(jt,ut=>{t.chapter.saveStatus==="error"&&ut($t)},!0)}l(We,pt)};S(Ut,We=>{t.chapter.saveStatus==="saved"?We(Zt):We(It,!1)},!0)}l(ke,lt)};S(it,ke=>{t.chapter.saveStatus==="saving"?ke(me):ke(Je,!1)},!0)}l(Te,ot)};S(xe,Te=>{t.chapter.deleteStatus==="error"?Te(Ct):Te(He,!1)},!0)}l(R,X)};S(w,R=>{t.chapter.deleteStatus==="deleted"?R(U):R(Oe,!1)},!0)}l(u,g)};S(ge,u=>{t.chapter.deleteStatus==="deleting"?u(rt):u(vt,!1)})}var Ge=i(ge,2),at=i(o(Ge),2);or(at,{textClass:"text-sm text-app",fieldName:"volume",get value(){return e(j)},set value(u){a(j,u,!0)}}),n(Ge);var W=i(Ge,2),ne=i(o(W),2);or(ne,{textClass:"text-sm text-app",fieldName:"chapter",get value(){return e(O)},set value(u){a(O,u,!0)}}),n(W),n(V);var he=i(V,2),ee=o(he);{var xt=u=>{var g=ba();g.__click=f,M(()=>g.disabled=t.chapter.saveStatus==="saving"||t.chapter.deleteStatus==="deleting"),l(u,g)};S(ee,u=>{t.chapter.isModified&&u(xt)})}var Be=i(ee,2);Be.__click=_;var Ae=o(Be);{var st=u=>{var g=ue("Saving...");l(u,g)},Et=u=>{var g=re(),w=ae(g);{var U=R=>{var X=ue("Saved");l(R,X)},Oe=R=>{var X=ue("Save");l(R,X)};S(w,R=>{t.chapter.saveStatus==="saved"?R(U):R(Oe,!1)},!0)}l(u,g)};S(Ae,u=>{t.chapter.saveStatus==="saving"?u(st):u(Et,!1)})}n(Be);var nt=i(Be,2);nt.__click=x;var Nt=o(nt);{var qe=u=>{var g=ue("Deleting...");l(u,g)},Ue=u=>{var g=re(),w=ae(g);{var U=R=>{var X=ue("Deleted");l(R,X)},Oe=R=>{var X=ue("Delete");l(R,X)};S(w,R=>{t.chapter.deleteStatus==="deleted"?R(U):R(Oe,!1)},!0)}l(u,g)};S(Nt,u=>{t.chapter.deleteStatus==="deleting"?u(qe):u(Ue,!1)})}n(nt),n(he),n(T);var Ke=i(T,2),St=i(o(Ke),2),Dt=o(St);or(Dt,{textClass:"text-sm text-app font-medium",fieldName:"title",get value(){return e(q)},set value(u){a(q,u,!0)}}),n(St),n(Ke);var ye=i(Ke,2),we=i(o(ye),2);{let u=Pt(()=>yt.map(g=>g.id));ur(we,{get items(){return e(u)},getDisplayText:g=>{const w=yt.find(U=>U.id===g);return w?dr(w):g},class:"uno-6zz63e",get selectedItem(){return e(H)},set selectedItem(g){a(H,g,!0)}})}n(ye);var Le=i(ye,2),Qe=i(o(Le),2);Dr(Qe,{fieldName:"groups",get groups(){return e(c)},set groups(u){a(c,u,!0)}}),n(Le);var je=i(Le,2);{var fe=u=>{var g=Ga(),w=o(g,!0);n(g),M(()=>z(w,t.chapter.error)),l(u,g)};S(je,u=>{t.chapter.error&&u(fe)})}n(N),M(()=>{Er(N,1,`uno-nbs6j7 ${t.chapter.isModified?"uno-o2133m":"uno-hyivlq"} ${t.chapter.saveStatus==="saving"?"uno-bl96x2":""} ${s()??""}`),z(ct,`#${t.index+1}`),z(Ve,`ID: ${t.chapter.id??""}`),Be.disabled=!t.chapter.isModified||t.chapter.saveStatus==="saving"||t.chapter.deleteStatus==="deleting",nt.disabled=t.chapter.saveStatus==="saving"||t.chapter.deleteStatus==="deleting"||t.chapter.deleteStatus==="deleted"}),l(ce,N),qt()}lr(["click"]);var xa=y('<p class="uno-noy726"> </p>'),Ea=y('<div class="uno-pwf4xz"><div class="uno-evm2ed"><h3 class="uno-q72ify">Chapters <!></h3> <div class="uno-6fwta5"><!> <div class="uno-6fwta5"><span class="uno-qmkpzb">Filter by Language:</span> <!></div></div></div> <div class="uno-23f7cj"></div></div>');function Na(ce,t){Vt(t,!0);let s=Mt(t,"editorState",7),d=Pt(()=>s().getFilteredChapters());var C=Ea(),c=o(C),A=o(c),B=i(o(A));{var q=f=>{var _=ue();M(()=>z(_,`(${e(d).length??""} of ${s().chapters.length??""})`)),l(f,_)},j=f=>{var _=ue();M(()=>z(_,`(${s().chapters.length??""})`)),l(f,_)};S(B,f=>{s().selectedLanguageFilter!==At?f(q):f(j,!1)})}n(A);var O=i(A,2),H=o(O);{var te=f=>{var _=xa(),x=o(_);n(_),M(N=>z(x,`${N??""} modified`),[()=>s().getModifiedChapters().length]),l(f,_)};S(H,f=>{s().getModifiedChapters().length>0&&f(te)})}var K=i(H,2),I=i(o(K),2);{let f=Pt(()=>[At,...yt.map(_=>_.id)]);ur(I,{get items(){return e(f)},getDisplayText:_=>{if(_===At)return"All Languages";const x=yt.find(N=>N.id===_);return x?dr(x):_},class:"uno-hzydes",get selectedItem(){return s().selectedLanguageFilter},set selectedItem(_){s().selectedLanguageFilter=_}})}n(K),n(O),n(c);var D=i(c,2);Bt(D,21,()=>e(d),Kt,(f,_,x)=>{ya(f,{index:x,get chapter(){return e(_)},get editorState(){return s()},get availableGroups(){return t.availableGroups}})}),n(D),n(C),l(ce,C),qt()}var Da=y('<span class="uno-07yj5v svelte-1ln36r3"> </span>'),Ra=y('<p class="uno-8v6iry svelte-1ln36r3">Loading chapter data...</p>'),wa=y('<p class="uno-3jftni svelte-1ln36r3"> </p>'),La=y('<p class="uno-jhlw6i svelte-1ln36r3">No dumped chapter lookups available.</p>'),Oa=y('<span class="uno-we5q6p svelte-1ln36r3"> </span>'),Ta=y('<span class="uno-k235uq svelte-1ln36r3"> </span>'),ka=y('<span class="uno-cf9y7u svelte-1ln36r3">→ No match found</span>'),Fa=y('<li class="svelte-1ln36r3"><span class="uno-mh207y svelte-1ln36r3"> </span> <!></li>'),Pa=y('<div class="uno-drcsp4 svelte-1ln36r3"><p class="uno-syw3wp svelte-1ln36r3"> <!></p> <ul class="uno-a92fuv svelte-1ln36r3"></ul></div>'),Ma=y('<p class="uno-eupyuk svelte-1ln36r3"> </p>'),za=y('<li class="svelte-1ln36r3"> </li>'),Va=y('<div class="uno-drcsp4 svelte-1ln36r3"><p class="uno-1fo7jt svelte-1ln36r3"> </p> <ul class="uno-q4h1v1 svelte-1ln36r3"></ul></div>'),qa=y('<div class="uno-47pxnt svelte-1ln36r3"><button type="button" class="uno-xb9urp svelte-1ln36r3">Apply Groups to Chapters</button> <button type="button" class="uno-vygkkt svelte-1ln36r3">Assign Titles to Chapters</button> <button type="button" class="uno-2lgh09 svelte-1ln36r3">Fix Missing Groups</button></div>'),Ua=y('<p class="uno-v610wo svelte-1ln36r3">Applying groups to chapters... <!></p>'),ja=y('<p class="uno-v610wo svelte-1ln36r3">Assigning titles to chapters... <!></p>'),Ha=y('<p class="uno-v610wo svelte-1ln36r3">Fixing missing groups... <!></p>'),Ja=y('<p class="uno-ovi0sm svelte-1ln36r3"> </p>'),Wa=y('<p class="uno-ovi0sm svelte-1ln36r3"> </p>'),Xa=y('<li class="svelte-1ln36r3"><span class="uno-mh207y svelte-1ln36r3"> </span> <span class="uno-2ve4eu svelte-1ln36r3">(<!>)</span></li>'),Ya=y('<div class="uno-drcsp4 svelte-1ln36r3"><p class="uno-1fo7jt svelte-1ln36r3"> </p> <ul class="uno-cwbkfr svelte-1ln36r3"></ul></div>'),Ba=y('<div class="uno-sve4ke svelte-1ln36r3"><p class="uno-v6fon0 svelte-1ln36r3"> </p> <!> <!> <!> <!> <!> <!> <!></div>'),Ka=y('<div class="uno-zrkrqo svelte-1ln36r3"><div class="uno-whtoz0 svelte-1ln36r3"><h3 class="uno-yuozvl svelte-1ln36r3">Chapter Dump Lookup</h3> <!></div> <!> <form class="uno-nypp1l svelte-1ln36r3"><div class="uno-r9zule svelte-1ln36r3"><p class="uno-83dpzr svelte-1ln36r3">Extract Volume from Title (Regex):</p> <input type="text" placeholder="Vol\\\\.? ?(\\\\d+)" class="uno-rtdrcq svelte-1ln36r3"/></div> <div class="uno-q5h8w1 svelte-1ln36r3"><label class="uno-qo6ajo svelte-1ln36r3"><input type="checkbox" class="uno-k04mdc svelte-1ln36r3"/> <span class="uno-8v6iry svelte-1ln36r3">Case Sensitive</span></label> <!> <button type="submit" class="uno-emxelj svelte-1ln36r3">Apply</button></div></form> <form class="uno-zn8ifb svelte-1ln36r3"><div class="uno-r9zule svelte-1ln36r3"><p class="uno-83dpzr svelte-1ln36r3">Extract Chapter Number from Title (Regex):</p> <input type="text" placeholder="(?:Ch\\\\.?|Chapter) ?(\\\\d+(?:\\\\.\\\\d+)?)" class="uno-rtdrcq svelte-1ln36r3"/></div> <div class="uno-q5h8w1 svelte-1ln36r3"><label class="uno-qo6ajo svelte-1ln36r3"><input type="checkbox" class="uno-k04mdc svelte-1ln36r3"/> <span class="uno-8v6iry svelte-1ln36r3">Case Sensitive</span></label> <!> <button type="submit" class="uno-emxelj svelte-1ln36r3">Apply</button></div></form> <form class="uno-zn8ifb svelte-1ln36r3"><div class="uno-q5h8w1 svelte-1ln36r3"><p class="uno-83dpzr svelte-1ln36r3">Assign Volume to All Chapters:</p> <input type="text" placeholder="Volume number" class="uno-486g9a svelte-1ln36r3"/></div> <div class="uno-q5h8w1 svelte-1ln36r3"><!> <button type="submit" class="uno-emxelj svelte-1ln36r3">Apply</button></div></form> <form class="uno-zn8ifb svelte-1ln36r3"><div class="uno-q5h8w1 svelte-1ln36r3"><p class="uno-83dpzr svelte-1ln36r3">Assign Chapter Number to All Chapters:</p> <input type="text" placeholder="Chapter number" class="uno-486g9a svelte-1ln36r3"/></div> <div class="uno-q5h8w1 svelte-1ln36r3"><!> <button type="submit" class="uno-emxelj svelte-1ln36r3">Apply</button></div></form> <form class="uno-zn8ifb svelte-1ln36r3"><div class="uno-q5h8w1 svelte-1ln36r3"><p class="uno-83dpzr svelte-1ln36r3">Assign Title to All Chapters:</p> <input type="text" placeholder="Chapter title" class="uno-7r1c44 svelte-1ln36r3"/></div> <div class="uno-q5h8w1 svelte-1ln36r3"><!> <button type="submit" class="uno-emxelj svelte-1ln36r3">Apply</button></div></form> <form class="uno-zn8ifb svelte-1ln36r3"><div class="uno-k16sf9 svelte-1ln36r3"><p class="uno-83dpzr svelte-1ln36r3">Assign Groups to All Chapters:</p> <!></div> <div class="uno-q5h8w1 svelte-1ln36r3"><!> <button type="submit" class="uno-emxelj svelte-1ln36r3">Set Group(s)</button> <button type="button" class="uno-emxelj svelte-1ln36r3">Append Group(s)</button></div></form> <form class="uno-zn8ifb svelte-1ln36r3"><div class="uno-q5h8w1 svelte-1ln36r3"><p class="uno-83dpzr svelte-1ln36r3">Assign Language to All Chapters:</p> <!></div> <div class="uno-q5h8w1 svelte-1ln36r3"><!> <button type="submit" class="uno-emxelj svelte-1ln36r3">Apply</button></div></form></div>');function Qa(ce,t){Vt(t,!0);var s=(r=>(r.IDLE="IDLE",r.LOADING="LOADING",r.LOADED="LOADED",r.ERROR="ERROR",r.APPLYING_GROUPS="APPLYING_GROUPS",r.ASSIGNING_TITLES="ASSIGNING_TITLES",r.FIXING_MISSING_GROUPS="FIXING_MISSING_GROUPS",r))(s||{});let d=Mt(t,"availableGroups",27,()=>Y([]));if(!Qt(zt))throw new Error("ChapterEditorBatchEdit must be used within a component that provides ApiAuthContext context");let c=G("IDLE"),A=G(0),B=G(0),q=G(Y([])),j=G(null),O=G(0),H=G(Y([])),te=G(null),K=G(0),I=G(0),D=G(null),f=G(null),_=G(null),x=G(0),N=G("en");const T=Y({start:null,end:null});let V=G(null);const se=Y({start:null,end:null});let ct=G(null);const Ie=Y({start:null,end:null});let Ve=G(null);const be=Y({start:null,end:null});let tt=G(Y(new Nr));const ge=Y({start:null,end:null});let rt=G("Vol\\.? ?(\\d+)"),vt=G(!1);const Ge=Y({start:null,end:null});let at=G("(?:Ch\\.?|Chapter) ?(\\d+(?:\\.\\d+)?)"),W=G(!1);const ne=Y({start:null,end:null});let he=G(Y([])),ee=Pt(()=>t.editorState.getFilteredChapters());Re(()=>{(async()=>{const r=t.editorState.seriesId,h=t.editorState.processingStep;if(r){const E=r!==e(te);E&&e(te)!==null&&(a(c,"IDLE"),a(A,0),a(B,0),a(q,[],!0),a(j,null),a(O,0),a(H,[],!0),a(K,0),a(I,0),a(x,0),a(he,[],!0),a(D,null),a(f,null),a(_,null)),E&&e(c)!=="LOADING"&&(h===Se.LOADED||h===Se.ERROR)&&await Be()}else e(te)!==null&&xt()})()});function xt(){a(c,"IDLE"),a(A,0),a(B,0),a(q,[],!0),a(j,null),a(O,0),a(H,[],!0),a(te,null),a(K,0),a(I,0),a(x,0),a(he,[],!0),a(D,null),a(f,null),a(_,null)}async function Be(){const r=t.editorState.seriesId;if(r)try{if(!await Ae())return;if(!t.editorState.seriesId||t.editorState.seriesId!==r){a(c,"IDLE");return}await st(),a(c,"LOADED"),a(te,r,!0)}catch(h){a(c,"ERROR"),a(j,h instanceof Error?h.message:"Failed to load chapter data",!0),console.error("Error in processing pipeline:",h)}}async function Ae(){a(c,"LOADING"),a(j,null),a(A,0),a(B,0),a(q,[],!0),a(O,0),a(H,[],!0),a(K,0),a(I,0),a(he,[],!0);const r=t.editorState.seriesId;if(!r)return a(c,"IDLE"),!1;if(await dt.load(),!await dt.hasSeriesEntries(r))return a(te,r,!0),a(c,"IDLE"),!1;const E=await dt.getAllGroupNames(r),m=await dt.getUniqueVolumeChapterCombinations(r);return a(A,E.length,!0),a(q,E.map(p=>({detectedName:p,matchedGroup:null})),!0),a(B,m.length,!0),!0}async function st(){const r=t.editorState.seriesId;if(!r)return;if(!await dt.hasSeriesEntries(r)){console.warn("No entries found in chapter dump for this series");return}const E=await dt.getAllGroupNames(r);if(E.length===0){console.log("No groups found in chapter dump, but series has entries (likely all ungrouped)");return}const m=await ta(E,ra,d().map(v=>({groupName:v.groupName}))),p=new Map;for(const v of m.successful)p.set(v.name,v);for(const v of E)if(!p.has(v)){const b=d().find(L=>L.groupName===v);b&&b.groupId&&p.set(v,{id:b.groupId,name:b.groupName})}a(q,E.map(v=>({detectedName:v,matchedGroup:p.get(v)??null})),!0);for(const v of m.successful)if(!d().find(L=>L.groupName===v.name)){const L=new Lr;L.groupId=v.id,L.groupName=v.name,d().push(L)}a(H,m.failed,!0),a(O,m.successful.length,!0)}async function Et(){if(e(c)!=="LOADED"||!t.editorState.seriesId)return;a(c,"APPLYING_GROUPS");let r=0;const h=t.editorState.chapters.filter(m=>(m.modified.language!==void 0?m.modified.language:m.original.language)==="en"),E=h.length;a(D,{current:0,total:E},!0);try{const m=aa.createGroupIdToNameMap(d());for(let p=0;p<h.length;p++){const v=h[p];a(D,{current:p+1,total:E},!0);const b=v.original,L=b.relationships?.groups,J=L&&Array.isArray(L)?L.map(Ne=>Ne.id):[],k=v.modified.groups??J,Q=k.map(Ne=>m.get(Ne)).filter(Ne=>Ne!==void 0),Z=v.modified.title??b.title??null,Fe=Z===""?null:Z??null,_e=v.modified.volume??b.volume??null,Ee={chapterVolume:_e===""?null:_e??null,chapterNumber:b.chapter,originalFolderPath:null,groupIds:k,currentTitle:Fe},Xe=await ir.lookupChapterRelease(Ee,t.editorState.seriesId,Q,{useFallbackMatching:!0});if(!Xe)continue;const Wt=await ir.getAllGroupIdsForRelease(t.editorState.seriesId,Xe.release,d());if(Wt.length===0)continue;const wt=new Set(k),Lt=[];for(const Ne of Wt)wt.has(Ne)||(Lt.push(Ne),wt.add(Ne));Lt.length>0&&(t.editorState.updateChapterField(v.id,"groups",[...k,...Lt]),r++)}a(K,r,!0),a(D,null),a(c,"LOADED")}catch(m){a(D,null),a(c,"ERROR"),a(j,m instanceof Error?m.message:"Failed to apply groups to chapters",!0),console.error("Error applying groups to chapters:",m)}}async function nt(){if(e(c)!=="LOADED"||!t.editorState.seriesId)return;a(c,"FIXING_MISSING_GROUPS");let r=0;const E=t.editorState.chapters.filter(p=>(p.modified.language??p.original.language)==="en").filter(p=>{const b=p.original.relationships?.groups,L=b&&Array.isArray(b)?b.map(k=>k.id):[];return(p.modified.groups??L).length===0}),m=E.length;a(_,{current:0,total:m},!0);try{for(let p=0;p<E.length;p++){const v=E[p];a(_,{current:p+1,total:m},!0);const b=v.original,L=v.modified.volume??b.volume??null,J=L===""?null:L??null,k=b.chapter;let Q=null,Z=J;if(J!==null&&k!==null&&(Q=await dt.getUniqueChapterInfo(t.editorState.seriesId,J,k)),!Q&&k!==null){const _e=await dt.getUniqueChapterInfoByChapter(t.editorState.seriesId,k);_e&&(Q=_e.info,Z=_e.volume)}if(!Q)continue;const Fe=await ir.getAllGroupIdsForRelease(t.editorState.seriesId,Q,d());Fe.length!==0&&(t.editorState.updateChapterField(v.id,"groups",Fe),Z!==null&&Z!==J&&t.editorState.updateChapterField(v.id,"volume",Z),r++)}a(x,r,!0),a(_,null),a(c,"LOADED")}catch(p){a(_,null),a(c,"ERROR"),a(j,p instanceof Error?p.message:"Failed to fix missing groups",!0),console.error("Error fixing missing groups:",p)}}async function Nt(){if(e(c)!=="LOADED"||!t.editorState.seriesId)return;a(c,"ASSIGNING_TITLES");const r=[],h=t.editorState.chapters.filter(m=>(m.modified.language??m.original.language)==="en"),E=h.length;a(f,{current:0,total:E},!0);try{const m=new Map,p=[];for(const b of h){const L=b.original,J=L.relationships?.groups,k=J&&Array.isArray(J)?J.map(Xe=>Xe.id):[],Q=b.modified.groups??k,Z=b.modified.title??L.title??null,Fe=Z===""?null:Z??null,_e=b.modified.volume??L.volume??null,Ee={chapterVolume:_e===""?null:_e??null,chapterNumber:L.chapter,originalFolderPath:null,groupIds:Q,currentTitle:Fe};p.push(Ee),m.set(Ee,b)}const v=await sa.applyChangesFromDump(p,d(),t.editorState.seriesId,{useFallbackMatching:!0,isNoGroupChapter:()=>!1});for(let b=0;b<v.results.length;b++){a(f,{current:b+1,total:E},!0);const L=v.results[b],J=p[b],k=m.get(J);if(k)if((L.status===Ar.SUCCESS||L.status===Ar.NO_CHANGES)&&L.changes){const{volume:Q,title:Z,additionalGroupIds:Fe}=L.changes,_e=k.original;if(Z!==void 0){const Pe=Z===null||Z===""?null:Z,Ee=_e.title??null;Pe!==Ee&&t.editorState.updateChapterField(k.id,"title",Pe)}if(Q!==void 0){const Pe=_e.volume??null;Q!==Pe&&t.editorState.updateChapterField(k.id,"volume",Q)}if(Fe.length>0){const Ee=[...k.modified.groups??k.original.relationships?.groups?.map(Xe=>Xe.id)??[],...Fe];t.editorState.updateChapterField(k.id,"groups",Ee)}}else{const Q=k.original,Z=L.warnings.length>0?L.warnings[0].reason:Ft.NO_CHAPTER_INFO;r.push({volume:J.chapterVolume,chapter:J.chapterNumber,chapterId:Q.id,reason:Z})}}a(I,v.successCount,!0),a(he,r,!0),a(f,null),a(c,"LOADED")}catch(m){a(f,null),a(c,"ERROR"),a(j,m instanceof Error?m.message:"Failed to assign titles to chapters",!0),console.error("Error assigning titles to chapters:",m)}}function qe(){const r=e(ee),h=(T.start??1)-1,E=(T.end??r.length)-1,m=e(N)?.trim()||"en";for(let p=h;p<=E;p++){const v=r[p];t.editorState.updateChapterField(v.id,"language",m)}}function Ue(){const r=e(ee),h=(se.start??1)-1,E=(se.end??r.length)-1,m=e(V)===void 0||e(V)===null||e(V)===""?null:e(V).trim()||null;for(let p=h;p<=E;p++){const v=r[p],b=v.original.volume??null;m!==b&&t.editorState.updateChapterField(v.id,"volume",m)}}function Ke(){const r=e(ee),h=(Ie.start??1)-1,E=(Ie.end??r.length)-1,m=e(ct)?.trim()||null;for(let p=h;p<=E;p++){const v=r[p];t.editorState.updateChapterField(v.id,"chapter",m)}}function St(){const r=e(ee),h=(be.start??1)-1,E=(be.end??r.length)-1,m=e(Ve)===void 0||e(Ve)===null||e(Ve)===""?null:e(Ve).trim()||null;for(let p=h;p<=E;p++){const v=r[p],b=v.original.title??null;m!==b&&t.editorState.updateChapterField(v.id,"title",m)}}function Dt(){const r=e(ee),h=(ge.start??1)-1,E=(ge.end??r.length)-1,m=e(tt).groupIds??[];for(let p=h;p<=E;p++){const v=r[p];t.editorState.updateChapterField(v.id,"groups",[...m])}}function ye(){const r=e(ee),h=(ge.start??1)-1,E=(ge.end??r.length)-1,m=e(tt).groupIds??[];for(let p=h;p<=E;p++){const v=r[p],L=[...v.modified.groups??v.original.relationships?.groups?.map(k=>k.id)??[],...m],J=[...new Set(L)];t.editorState.updateChapterField(v.id,"groups",J)}}function we(r){const h=r.modified.title??r.original.title??null;return h===""?"":h??""}function Le(){if(!e(rt).trim())return;const r=e(ee),h=e(vt)?"":"i",E=new RegExp(e(rt),h),m=(Ge.start??1)-1,p=(Ge.end??r.length)-1;for(let v=m;v<=p;v++){const b=r[v],J=we(b).match(E);if(J&&J[1]){const k=J[1].replace(/^0+/,"");t.editorState.updateChapterField(b.id,"volume",k)}}}function Qe(){if(!e(at).trim())return;const r=e(ee),h=e(W)?"":"i",E=new RegExp(e(at),h),m=(ne.start??1)-1,p=(ne.end??r.length)-1;for(let v=m;v<=p;v++){const b=r[v],J=we(b).match(E);if(J&&J[1]){const k=J[1].replace(/^0+/,"");t.editorState.updateChapterField(b.id,"chapter",k)}}}var je=Ka(),fe=o(je),u=i(o(fe),2);{var g=r=>{var h=Da(),E=o(h);n(h),M(()=>z(E,`(${e(ee).length??""} of ${t.editorState.chapters.length??""} chapters shown)`)),l(r,h)};S(u,r=>{t.editorState.selectedLanguageFilter!==At&&r(g)})}n(fe);var w=i(fe,2);{var U=r=>{var h=Ra();l(r,h)},Oe=r=>{var h=re(),E=ae(h);{var m=v=>{var b=wa(),L=o(b,!0);n(b),M(()=>z(L,e(j))),l(v,b)},p=v=>{var b=re(),L=ae(b);{var J=Q=>{var Z=La();l(Q,Z)},k=Q=>{var Z=re(),Fe=ae(Z);{var _e=Pe=>{var Ee=Ba(),Xe=o(Ee),Wt=o(Xe);n(Xe);var wt=i(Xe,2);{var Lt=F=>{var P=Pa(),$=o(P),Me=o($),ze=i(Me);{var De=de=>{var ie=Oa(),Ce=o(ie);n(ie),M(()=>z(Ce,`(${e(O)??""}
								${e(O)===1?"group":"groups"} added)`)),l(de,ie)};S(ze,de=>{e(O)>0&&de(De)})}n($);var oe=i($,2);Bt(oe,21,()=>e(q),Kt,(de,ie)=>{var Ce=Fa(),ve=o(Ce),Ye=o(ve,!0);n(ve);var gt=i(ve,2);{var ht=le=>{var Ze=Ta(),Ot=o(Ze);n(Ze),M(()=>z(Ot,`→ ${e(ie).matchedGroup.name??""} (ID: ${e(ie).matchedGroup.id??""})`)),l(le,Ze)},pe=le=>{var Ze=ka();l(le,Ze)};S(gt,le=>{e(ie).matchedGroup?le(ht):le(pe,!1)})}n(Ce),M(()=>z(Ye,e(ie).detectedName)),l(de,Ce)}),n(oe),n(P),M(()=>z(Me,`Detected Groups (${e(q).length??""}): `)),l(F,P)};S(wt,F=>{e(q).length>0&&F(Lt)})}var Ne=i(wt,2);{var zr=F=>{var P=Ma(),$=o(P);n(P),M(()=>z($,`Added ${e(O)??""}
					${e(O)===1?"group":"groups"} to available scan groups.`)),l(F,P)};S(Ne,F=>{e(O)>0&&e(q).length===0&&F(zr)})}var _r=i(Ne,2);{var Vr=F=>{var P=Va(),$=o(P),Me=o($);n($);var ze=i($,2);Bt(ze,21,()=>e(H),Kt,(De,oe)=>{var de=za(),ie=o(de,!0);n(de),M(()=>z(ie,e(oe))),l(De,de)}),n(ze),n(P),M(()=>z(Me,`Warning: Failed to lookup ${e(H).length??""} 
						${e(H).length===1?"group":"groups"}:`)),l(F,P)};S(_r,F=>{e(H).length>0&&F(Vr)})}var Sr=i(_r,2);{var qr=F=>{var P=qa(),$=o(P);$.__click=Et;var Me=i($,2);Me.__click=Nt;var ze=i(Me,2);ze.__click=nt,n(P),l(F,P)},Ur=F=>{var P=re(),$=ae(P);{var Me=De=>{var oe=Ua(),de=i(o(oe));{var ie=Ce=>{var ve=ue();M(()=>z(ve,`(${e(D).current??""} / ${e(D).total??""})`)),l(Ce,ve)};S(de,Ce=>{e(D)&&Ce(ie)})}n(oe),l(De,oe)},ze=De=>{var oe=re(),de=ae(oe);{var ie=ve=>{var Ye=ja(),gt=i(o(Ye));{var ht=pe=>{var le=ue();M(()=>z(le,`(${e(f).current??""} / ${e(f).total??""})`)),l(pe,le)};S(gt,pe=>{e(f)&&pe(ht)})}n(Ye),l(ve,Ye)},Ce=ve=>{var Ye=re(),gt=ae(Ye);{var ht=pe=>{var le=Ha(),Ze=i(o(le));{var Ot=Tt=>{var $e=ue();M(()=>z($e,`(${e(_).current??""} / ${e(_).total??""})`)),l(Tt,$e)};S(Ze,Tt=>{e(_)&&Tt(Ot)})}n(le),l(pe,le)};S(gt,pe=>{e(c)===s.FIXING_MISSING_GROUPS&&pe(ht)},!0)}l(ve,Ye)};S(de,ve=>{e(c)===s.ASSIGNING_TITLES?ve(ie):ve(Ce,!1)},!0)}l(De,oe)};S($,De=>{e(c)===s.APPLYING_GROUPS?De(Me):De(ze,!1)},!0)}l(F,P)};S(Sr,F=>{e(c)===s.LOADED?F(qr):F(Ur,!1)})}var Cr=i(Sr,2);{var jr=F=>{var P=Ja(),$=o(P);n(P),M(()=>z($,`Applied ${e(K)??""}
					${e(K)===1?"group":"groups"} to chapters.`)),l(F,P)};S(Cr,F=>{e(K)>0&&F(jr)})}var Ir=i(Cr,2);{var Hr=F=>{var P=Wa(),$=o(P);n(P),M(()=>z($,`Assigned ${e(I)??""}
					${e(I)===1?"title":"titles"} to chapters.`)),l(F,P)};S(Ir,F=>{e(I)>0&&F(Hr)})}var Jr=i(Ir,2);{var Wr=F=>{var P=Ya(),$=o(P),Me=o($);n($);var ze=i($,2);Bt(ze,21,()=>e(he),Kt,(De,oe)=>{var de=Xa(),ie=o(de),Ce=o(ie);n(ie);var ve=i(ie,2),Ye=i(o(ve));{var gt=pe=>{var le=ue("No groups assigned");l(pe,le)},ht=pe=>{var le=re(),Ze=ae(le);{var Ot=$e=>{var Xt=ue("No valid groups found");l($e,Xt)},Tt=$e=>{var Xt=re(),Xr=ae(Xt);{var Yr=bt=>{var Yt=ue("No matching volume/chapter in export");l(bt,Yt)},Br=bt=>{var Yt=re(),Kr=ae(Yt);{var Qr=Gt=>{var sr=ue("No matching group in export");l(Gt,sr)},Zr=Gt=>{var sr=ue("Failed to match");l(Gt,sr)};S(Kr,Gt=>{e(oe).reason===Ft.NO_MATCHING_GROUP?Gt(Qr):Gt(Zr,!1)},!0)}l(bt,Yt)};S(Xr,bt=>{e(oe).reason===Ft.NO_CHAPTER_INFO?bt(Yr):bt(Br,!1)},!0)}l($e,Xt)};S(Ze,$e=>{e(oe).reason===Ft.NO_VALID_GROUPS?$e(Ot):$e(Tt,!1)},!0)}l(pe,le)};S(Ye,pe=>{e(oe).reason===Ft.NO_GROUPS?pe(gt):pe(ht,!1)})}et(),n(ve),n(de),M(()=>z(Ce,`Vol ${e(oe).volume??"N/A"??""}, Ch ${e(oe).chapter??"N/A"??""}`)),l(De,de)}),n(ze),n(P),M(()=>z(Me,`Warning: Unable to assign titles to ${e(he).length??""} 
						${e(he).length===1?"chapter":"chapters"} (volume and chapter must match
						exactly):`)),l(F,P)};S(Jr,F=>{e(he).length>0&&F(Wr)})}n(Ee),M(()=>z(Wt,`Found ${e(A)??""}
				${e(A)===1?"group":"groups"} and ${e(B)??""}
				${e(B)===1?"chapter":"chapters"} in chapter dump.`)),l(Pe,Ee)};S(Fe,Pe=>{(e(c)===s.LOADED||e(c)===s.APPLYING_GROUPS||e(c)===s.ASSIGNING_TITLES||e(c)===s.FIXING_MISSING_GROUPS)&&Pe(_e)},!0)}l(Q,Z)};S(L,Q=>{e(c)===s.IDLE?Q(J):Q(k,!1)},!0)}l(v,b)};S(E,v=>{e(c)===s.ERROR?v(m):v(p,!1)},!0)}l(r,h)};S(w,r=>{e(c)===s.LOADING?r(U):r(Oe,!1)})}var R=i(w,2),X=o(R),xe=i(o(X),2);ft(xe),n(X);var Ct=i(X,2),He=o(Ct),Te=o(He);ft(Te),et(2),n(He);var ot=i(He,2);_t(ot,{min:1,get max(){return e(ee).length},get rangeStart(){return Ge.start},set rangeStart(r){Ge.start=r},get rangeEnd(){return Ge.end},set rangeEnd(r){Ge.end=r}}),et(2),n(Ct),n(R);var it=i(R,2),me=o(it),Je=i(o(me),2);ft(Je),n(me);var ke=i(me,2),lt=o(ke),Ut=o(lt);ft(Ut),et(2),n(lt);var Zt=i(lt,2);_t(Zt,{min:1,get max(){return e(ee).length},get rangeStart(){return ne.start},set rangeStart(r){ne.start=r},get rangeEnd(){return ne.end},set rangeEnd(r){ne.end=r}}),et(2),n(ke),n(it);var It=i(it,2),We=o(It),pt=i(o(We),2);ft(pt),n(We);var jt=i(We,2),$t=o(jt);_t($t,{min:1,get max(){return e(ee).length},get rangeStart(){return se.start},set rangeStart(r){se.start=r},get rangeEnd(){return se.end},set rangeEnd(r){se.end=r}}),et(2),n(jt),n(It);var ut=i(It,2),Rt=o(ut),cr=i(o(Rt),2);ft(cr),n(Rt);var vr=i(Rt,2),Or=o(vr);_t(Or,{min:1,get max(){return e(ee).length},get rangeStart(){return Ie.start},set rangeStart(r){Ie.start=r},get rangeEnd(){return Ie.end},set rangeEnd(r){Ie.end=r}}),et(2),n(vr),n(ut);var Ht=i(ut,2),er=o(Ht),pr=i(o(er),2);ft(pr),n(er);var gr=i(er,2),Tr=o(gr);_t(Tr,{min:1,get max(){return e(ee).length},get rangeStart(){return be.start},set rangeStart(r){be.start=r},get rangeEnd(){return be.end},set rangeEnd(r){be.end=r}}),et(2),n(gr),n(Ht);var Jt=i(Ht,2),tr=o(Jt),kr=i(o(tr),2);Dr(kr,{get groups(){return e(tt)},set groups(r){a(tt,r,!0)}}),n(tr);var hr=i(tr,2),fr=o(hr);_t(fr,{min:1,get max(){return e(ee).length},get rangeStart(){return ge.start},set rangeStart(r){ge.start=r},get rangeEnd(){return ge.end},set rangeEnd(r){ge.end=r}});var Fr=i(fr,4);Fr.__click=ye,n(hr),n(Jt);var rr=i(Jt,2),ar=o(rr),Pr=i(o(ar),2);{let r=Pt(()=>yt.map(h=>h.id));ur(Pr,{get items(){return e(r)},getDisplayText:h=>{const E=yt.find(m=>m.id===h);return E?dr(E):h},class:"uno-ggujl7",get selectedItem(){return e(N)},set selectedItem(h){a(N,h,!0)}})}n(ar);var mr=i(ar,2),Mr=o(mr);_t(Mr,{min:1,get max(){return e(ee).length},get rangeStart(){return T.start},set rangeStart(r){T.start=r},get rangeEnd(){return T.end},set rangeEnd(r){T.end=r}}),et(2),n(mr),n(rr),n(je),mt("submit",R,r=>{Le(),r.preventDefault()}),kt(xe,()=>e(rt),r=>a(rt,r)),Gr(Te,()=>e(vt),r=>a(vt,r)),mt("submit",it,r=>{Qe(),r.preventDefault()}),kt(Je,()=>e(at),r=>a(at,r)),Gr(Ut,()=>e(W),r=>a(W,r)),mt("submit",It,r=>{Ue(),r.preventDefault()}),kt(pt,()=>e(V),r=>a(V,r)),mt("submit",ut,r=>{Ke(),r.preventDefault()}),kt(cr,()=>e(ct),r=>a(ct,r)),mt("submit",Ht,r=>{St(),r.preventDefault()}),kt(pr,()=>e(Ve),r=>a(Ve,r)),mt("submit",Jt,r=>{Dt(),r.preventDefault()}),mt("submit",rr,r=>{qe(),r.preventDefault()}),l(ce,je),qt()}lr(["click"]);function Za(ce,t){Vt(t,!0);let s=Mt(t,"editorState",7),d=Mt(t,"availableGroups",31,()=>Y([]));const C=Qt(zt);if(!C)throw new Error("ChapterEditorProcessor must be used within a component that provides ApiAuthContext context");let c=G(null),A=G(!1);function B(I){if(s().permissionOverride)return!0;if(!C.userIdentity)return!1;const D=C.userIdentity.id;if(I.relationships?.uploader?.id===D)return!0;const f=I.relationships?.groups;if(!f||!Array.isArray(f))return!1;const _=new Set(f.map(x=>x.id));if(!C.userGroups||!Array.isArray(C.userGroups))return!1;for(const x of C.userGroups)if(_.has(x.id)){const N=x.relationships?.members;if(!N||!Array.isArray(N))continue;const T=N.find(V=>V.id===D);if(T&&(T.is_leader||T.is_officer))return!0}return!1}Re(()=>{(async()=>{const I=s().seriesId,D=C.apiToken;C.userIdentity;const f=s().permissionOverride;if(!I||!D){e(c)!==null&&(s().chapters=[],s().filteredChaptersCount=0,s().processingStep=Se.IDLE,a(c,null));return}const _=I!==e(c),x=f!==e(A);(_||x||e(c)===null)&&(await q(),a(A,f,!0))})()});async function q(){if(!(!s().seriesId||!C.apiToken)){s().processingStep=Se.LOADING,s().loadError=null;try{const I=await na(s().seriesId),D=I.length,f=I.filter(T=>B(T));s().permissionOverride?s().filteredChaptersCount=0:s().filteredChaptersCount=D-f.length;const _=f.map(T=>({id:T.id,original:T,modified:{},isModified:!1,saveStatus:"pending",error:void 0}));s().chapters=_;const x=s().permissionOverride?I:f,N=new Map;for(const T of x)if(T?.relationships?.groups&&Array.isArray(T.relationships.groups)){for(const V of T.relationships.groups)if(V?.id&&V?.name&&!N.has(V.id)){const se=new Lr;se.groupId=V.id,se.groupName=V.name,N.set(V.id,se)}}d(Array.from(N.values())),s().processingStep=Se.LOADED,a(c,s().seriesId,!0),a(A,s().permissionOverride,!0)}catch(I){s().processingStep=Se.ERROR,s().loadError=I instanceof Error?I.message:"Failed to load chapters",console.error("Error loading chapters:",I)}}}async function j(){if(!C.apiToken){alert("No API token available");return}const I=s().getModifiedChapters();if(I.length===0){alert("No modified chapters to save");return}s().processingStep=Se.SAVING,s().isSavingAll=!0,s().saveProgress={current:0,total:I.length};let D=0,f=0;for(let _=0;_<I.length;_++){const x=I[_];s().saveProgress={current:_+1,total:I.length};try{const N=s().getChapterUpdateData(x);console.log("Saving chapter:",x.id),console.log("Update data:",N);const T=await Rr(x.id,N,C.apiToken);x.original=T,x.modified={},x.isModified=!1,x.saveStatus="saved",x.error=void 0,D++}catch(N){x.saveStatus="error",x.error=N instanceof Error?N.message:"Failed to save chapter",f++}}s().isSavingAll=!1,s().saveProgress=null,s().processingStep=Se.LOADED,f>0?alert(`Saved ${D} chapters. ${f} failed. Check individual chapters for errors.`):alert(`Successfully saved ${D} chapters.`)}function O(){const I=s().getModifiedChapters();for(const D of I)s().resetChapter(D.id)}function H(){a(c,null),a(A,!s().permissionOverride)}async function te(I){if(!C.apiToken){alert("No API token available");return}if(I.length===0){alert("No chapters selected for deletion");return}if(!confirm(`Are you sure you want to delete ${I.length} chapter(s)? This action cannot be undone.`))return;s().processingStep=Se.SAVING,s().isSavingAll=!0,s().saveProgress={current:0,total:I.length};let D=0,f=0;const _=[];for(let x=0;x<I.length;x++){const N=I[x];if(s().saveProgress={current:x+1,total:I.length},!s().chapters.find(V=>V.id===N)){f++;continue}try{s().updateChapterDeleteStatus(N,"deleting"),await wr(N,C.apiToken),s().updateChapterDeleteStatus(N,"deleted"),_.push(N),D++}catch(V){s().updateChapterDeleteStatus(N,"error",V instanceof Error?V.message:"Failed to delete chapter"),f++}}for(const x of _)s().removeChapter(x);s().isSavingAll=!1,s().saveProgress=null,s().processingStep=Se.LOADED,f>0?alert(`Deleted ${D} chapters. ${f} failed. Check individual chapters for errors.`):alert(`Successfully deleted ${D} chapters.`)}var K={saveAllModified:j,revertAllModified:O,reloadChapters:H,deleteAllSelected:te};return qt(K)}var $a=xr('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>'),es=xr('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>'),ts=y('<p class="uno-rvflv7">Loading chapters...</p>'),rs=y('<p class="uno-chd4ub"> </p>'),as=y('<span class="uno-0kvlub">All chapters visible (override enabled)</span>'),ss=y('<p class="uno-zir0it"> </p>'),ns=y('<div class="uno-7bik28"><button type="button" class="uno-gkei3v"> </button> <button type="button" class="uno-v6bita"><!></button></div>'),os=y('<div class="uno-wuf9ny"><div class="uno-a2k9zs"><div class="uno-dr6mtf"><h2 class="uno-alqayt">Chapters</h2> <!> <!></div> <!></div> <!></div>'),is=y('<div class="uno-wuf9ny"><p class="uno-94tecn">No accessible chapters found for this series.</p> <p class="uno-zir0it"> </p></div>'),ls=y('<p class="uno-94tecn">No chapters found for this series.</p>'),us=y('<div class="uno-js2hdc"><!> <!></div>'),ds=y('<p class="uno-94tecn">Please select a series to begin editing chapters.</p>'),cs=y('<div class="uno-91vis9"><div class="uno-7udnhq"><h1 class="uno-rgxfok">Chapter Mass Editor</h1> <div class="uno-7bik28"><button type="button" class="uno-546lus">Simple Mode</button> <button type="button" class="uno-546lus">Guided Mode</button> <!></div></div> <a target="_blank" class="uno-o7pvrl">Tutorial & Docs</a> <!> <!> <div class="uno-js2hdc"><div class="uno-wuf9ny"><div class="uno-a2k9zs"><h2 class="uno-alqayt">Series Selection</h2> <button type="button"><svg class="uno-t3x9d1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><!></svg> <span> </span></button></div> <!> <!></div> <!></div></div>');function ys(ce,t){Vt(t,!0),br(zt,new va);const s=new oa;br(ca,s);const d=new ga,C=Qt(zt);let c=G(Y([])),A=G(null);Re(()=>{d.seriesId=s.seriesId}),Re(()=>{s.availableScanGroups=e(c)});function B(){e(A)&&e(A).saveAllModified()}function q(){e(A)&&e(A).revertAllModified()}var j=cs(),O=o(j),H=i(o(O),2),te=o(H);te.__click=()=>yr(nr("/"));var K=i(te,2);K.__click=()=>yr(nr("/guided"));var I=i(K,2);ia(I,{}),n(H),n(O);var D=i(O,2),f=i(D,2);la(f,{});var _=i(f,2);ea(Za(_,{get editorState(){return d},get availableGroups(){return e(c)},set availableGroups(W){a(c,W,!0)}}),W=>a(A,W,!0),()=>e(A));var x=i(_,2),N=o(x),T=o(N),V=i(o(T),2);V.__click=()=>{d.permissionOverride=!d.permissionOverride,e(A)&&e(A).reloadChapters()};var se=o(V),ct=o(se);{var Ie=W=>{var ne=$a();l(W,ne)},Ve=W=>{var ne=es();l(W,ne)};S(ct,W=>{d.permissionOverride?W(Ie):W(Ve,!1)})}n(se);var be=i(se,2),tt=o(be,!0);n(be),n(V),n(T);var ge=i(T,2);ua(ge,{});var rt=i(ge,2);da(rt,{}),n(N);var vt=i(N,2);{var Ge=W=>{var ne=us(),he=o(ne);Qa(he,{get editorState(){return d},get availableGroups(){return e(c)},set availableGroups(Ae){a(c,Ae,!0)}});var ee=i(he,2);{var xt=Ae=>{var st=ts();l(Ae,st)},Be=Ae=>{var st=re(),Et=ae(st);{var nt=qe=>{var Ue=rs(),Ke=o(Ue,!0);n(Ue),M(()=>z(Ke,d.loadError)),l(qe,Ue)},Nt=qe=>{var Ue=re(),Ke=ae(Ue);{var St=ye=>{var we=os(),Le=o(we),Qe=o(Le),je=i(o(Qe),2);{var fe=R=>{var X=as();l(R,X)};S(je,R=>{d.permissionOverride&&R(fe)})}var u=i(je,2);{var g=R=>{var X=ss(),xe=o(X);n(X),M(()=>z(xe,`${d.filteredChaptersCount??""}
										${d.filteredChaptersCount===1?"chapter":"chapters"} hidden due to
										insufficient permissions`)),l(R,X)};S(u,R=>{d.filteredChaptersCount>0&&!d.permissionOverride&&R(g)})}n(Qe);var w=i(Qe,2);{var U=R=>{var X=ns(),xe=o(X);xe.__click=q;var Ct=o(xe);n(xe);var He=i(xe,2);He.__click=B;var Te=o(He);{var ot=me=>{var Je=ue();M(()=>z(Je,`Saving... (${d.saveProgress?.current??0??""} / ${d.saveProgress?.total??0??""})`)),l(me,Je)},it=me=>{var Je=ue();M(ke=>z(Je,`Save All Modified (${ke??""})`),[()=>d.getModifiedChapters().length]),l(me,Je)};S(Te,me=>{d.isSavingAll?me(ot):me(it,!1)})}n(He),n(X),M(me=>{xe.disabled=d.isSavingAll,z(Ct,`Revert All (${me??""})`),He.disabled=d.isSavingAll||!C.apiToken},[()=>d.getModifiedChapters().length]),l(R,X)};S(w,R=>{d.getModifiedChapters().length>0&&R(U)})}n(Le);var Oe=i(Le,2);Na(Oe,{get editorState(){return d},get availableGroups(){return e(c)}}),n(we),l(ye,we)},Dt=ye=>{var we=re(),Le=ae(we);{var Qe=fe=>{var u=is(),g=i(o(u),2),w=o(g);n(g),n(u),M(()=>z(w,`${d.filteredChaptersCount??""}
							${d.filteredChaptersCount===1?"chapter":"chapters"}
							${d.filteredChaptersCount===1?"was":"were"} filtered out due to insufficient
							permissions.`)),l(fe,u)},je=fe=>{var u=re(),g=ae(u);{var w=U=>{var Oe=ls();l(U,Oe)};S(g,U=>{d.processingStep===Se.LOADED&&U(w)},!0)}l(fe,u)};S(Le,fe=>{d.filteredChaptersCount>0?fe(Qe):fe(je,!1)},!0)}l(ye,we)};S(Ke,ye=>{d.processingStep===Se.LOADED&&d.chapters.length>0?ye(St):ye(Dt,!1)},!0)}l(qe,Ue)};S(Et,qe=>{d.loadError?qe(nt):qe(Nt,!1)},!0)}l(Ae,st)};S(ee,Ae=>{d.processingStep===Se.LOADING?Ae(xt):Ae(Be,!1)})}n(ne),l(W,ne)},at=W=>{var ne=ds();l(W,ne)};S(vt,W=>{d.seriesId?W(Ge):W(at,!1)})}n(x),n(j),M(W=>{$r(D,"href",W),Er(V,1,`uno-w46u2s ${d.permissionOverride?"uno-com2eg":"uno-17pzu5 hover:bg-surface-border border-surface-border"}`),z(tt,d.permissionOverride?"Override Enabled":"Override Permissions")},[()=>nr("/docs")]),l(ce,j),qt()}lr(["click"]);export{ys as component,As as universal};
