import{d as lr,f as y,a as l,g as te,t as ue,e as ft,i as xr}from"../chunks/BxO5phG-.js";import{s as G,i as e,j as a,p as Y,D as Vt,aK as Kt,u as Le,J as o,K as n,M as i,aF as Pt,G as M,I as qt,F as re,ac as et,aI as br}from"../chunks/CRcVDNR5.js";import{s as z}from"../chunks/Hw7lrUnh.js";import{i as S}from"../chunks/BXYtgQMH.js";import{r as mt,s as $r}from"../chunks/BBqLALQB.js";import{s as Er,r as sr}from"../chunks/0hYrALgK.js";import{p as Mt,b as ea}from"../chunks/DgnEiYPT.js";import{C as Nr,T as nr,D as ur,a as Dr,u as Rr,d as wr,e as Bt,c as dt,l as ta,s as ra,S as Lr,b as kt,f as Gr,i as or,W as Ft,U as aa,R as ir,g as sa,h as Ar,j as na,k as oa,m as ia,n as la,o as ua,p as da,t as ca}from"../chunks/BYr44Yry.js";import{b as zt,A as va}from"../chunks/CNi4FeGA.js";import{l as yt,g as dr,R as _t}from"../chunks/DS1C84rF.js";import{g as yr}from"../chunks/znaoNMEx.js";const pa=!0,Gs=Object.freeze(Object.defineProperty({__proto__:null,prerender:pa},Symbol.toStringTag,{value:"Module"}));var Se=(ce=>(ce.IDLE="IDLE",ce.LOADING="LOADING",ce.LOADED="LOADED",ce.ERROR="ERROR",ce.SAVING="SAVING",ce))(Se||{});const At="__all__";class ga{#e=G(null);get seriesId(){return e(this.#e)}set seriesId(t){a(this.#e,t,!0)}#t=G(Y([]));get chapters(){return e(this.#t)}set chapters(t){a(this.#t,t,!0)}#r=G(!1);get isLoading(){return e(this.#r)}set isLoading(t){a(this.#r,t,!0)}#a=G(null);get loadError(){return e(this.#a)}set loadError(t){a(this.#a,t,!0)}#s=G(!1);get isSavingAll(){return e(this.#s)}set isSavingAll(t){a(this.#s,t,!0)}#n=G(null);get saveProgress(){return e(this.#n)}set saveProgress(t){a(this.#n,t,!0)}#o=G("IDLE");get processingStep(){return e(this.#o)}set processingStep(t){a(this.#o,t,!0)}#i=G(0);get filteredChaptersCount(){return e(this.#i)}set filteredChaptersCount(t){a(this.#i,t,!0)}#l=G(!1);get permissionOverride(){return e(this.#l)}set permissionOverride(t){a(this.#l,t,!0)}#u=G(At);get selectedLanguageFilter(){return e(this.#u)}set selectedLanguageFilter(t){a(this.#u,t,!0)}reset(){this.seriesId=null,this.chapters=[],this.isLoading=!1,this.loadError=null,this.isSavingAll=!1,this.saveProgress=null}getModifiedChapters(){return this.chapters.filter(t=>t.isModified)}markChapterModified(t){const s=this.chapters.find(d=>d.id===t);s&&(s.isModified=!0,s.saveStatus==="saved"&&(s.saveStatus="pending"))}updateChapterField(t,s,d){const I=this.chapters.find(N=>N.id===t);if(!I)return;let c=d;(s==="title"||s==="volume")&&typeof d=="string"&&d===""&&(c=null),I.modified[s]=c;const A=I.original,B=I.modified,q=A.relationships?.groups,U=q&&Array.isArray(q)?q.map(N=>N.id).sort():[],O=B.groups?[...B.groups].sort():null,H=B.chapter??A.chapter,ee=A.chapter,Q=B.volume??A.volume,b=A.volume,D=B.title??A.title,h=A.title,_=B.language??A.language,x=A.language;I.isModified=H!==ee||Q!==b||D!==h||_!==x||JSON.stringify(O)!==JSON.stringify(U),I.isModified&&I.saveStatus==="saved"&&(I.saveStatus="pending")}getChapterUpdateData(t){const s=t.original,d=t.modified,I=s.relationships?.groups,c=I&&Array.isArray(I)?I.map(A=>A.id):[];return{chapter:d.chapter??s.chapter,volume:(d.volume!==void 0?d.volume:s.volume)??"",title:(d.title!==void 0?d.title:s.title)??"",language:d.language??s.language,version:s.version,groups:d.groups!==void 0?d.groups:c}}resetChapter(t){const s=this.chapters.find(d=>d.id===t);s&&(s.modified={},s.isModified=!1,s.saveStatus="pending",s.error=void 0)}updateChapterSaveStatus(t,s,d){const I=this.chapters.find(c=>c.id===t);I&&(I.saveStatus=s,d!==void 0&&(I.error=d))}updateChapterAfterSave(t,s){const d=this.chapters.find(I=>I.id===t);d&&(d.original=s,d.modified={},d.isModified=!1,d.saveStatus="saved",d.error=void 0)}updateChapterDeleteStatus(t,s,d){const I=this.chapters.find(c=>c.id===t);I&&(I.deleteStatus=s,d!==void 0&&(I.error=d))}removeChapter(t){this.chapters=this.chapters.filter(s=>s.id!==t)}getFilteredChapters(){return this.selectedLanguageFilter===At?this.chapters:this.chapters.filter(t=>(t.modified.language??t.original.language)===this.selectedLanguageFilter)}}var ha=y('<span class="uno-clz4zx">* Modified</span>'),fa=y('<span class="uno-ptr006">Deleting...</span>'),ma=y('<span class="uno-rn7dpy">Deleted</span>'),_a=y('<span class="uno-dubrca">Delete Error</span>'),Sa=y('<span class="uno-ocbf92">Saving...</span>'),Ca=y('<span class="uno-rn7dpy">Saved</span>'),Ia=y('<span class="uno-dubrca">Error</span>'),ba=y('<button type="button" class="uno-mih921">Revert</button>'),Ga=y('<p class="uno-dubrca"> </p>'),Aa=y('<div><div class="uno-ln4tmt"><div class="uno-1akirq"><span class="uno-3pnkic"> </span> <span class="uno-o40rdu"> </span> <!> <!> <div class="uno-mzdrk4"><span class="uno-o40rdu">Vol:</span> <!></div> <div class="uno-mzdrk4"><span class="uno-o40rdu">Ch:</span> <!></div></div> <div class="uno-mzdrk4"><!> <button type="button" class="uno-r3dsj6"><!></button> <button type="button" class="uno-setv31"><!></button></div></div> <div class="uno-mzdrk4"><span class="uno-o40rdu">Title:</span> <div class="uno-b83ayl"><!></div></div> <div class="uno-mzdrk4"><span class="uno-o40rdu">Language:</span> <!></div> <div class="uno-mzdrk4"><span class="uno-o40rdu">Groups:</span> <!></div> <!></div>');function ya(ce,t){Vt(t,!0);let s=Mt(t,"class",3,"");const d=Kt(zt);if(!d)throw new Error("ChapterEditorItem must be used within a component that provides ApiAuthContext context");function I(){if(t.chapter.modified.groups!==void 0)return t.chapter.modified.groups;const u=t.chapter.original.relationships?.groups;return u&&Array.isArray(u)?u.map(g=>g.id):[]}let c=G(Y(new Nr));Le(()=>{e(c).groupIds=I()}),Le(()=>{const u=e(c).groupIds??[],g=[...u].sort(),j=[...I()].sort();JSON.stringify(g)!==JSON.stringify(j)&&t.editorState.updateChapterField(t.chapter.id,"groups",u)}),Le(()=>{const u=I(),L=[...e(c).groupIds??[]].sort(),j=[...u].sort();JSON.stringify(L)!==JSON.stringify(j)&&(e(c).groupIds=u)});function A(u){const g=t.chapter.modified[u];if(g!==void 0)return g;const L=t.chapter.original[u];return L!==void 0?L:null}function B(){const u=t.chapter.modified.language;return u!==void 0?u:t.chapter.original.language}let q=G(Y(A("title")??null)),U=G(Y(A("volume")??null)),O=G(Y(A("chapter")??null)),H=G(Y(B())),ee=G(Y(A("title")??null)),Q=G(Y(A("volume")??null)),b=G(Y(A("chapter")??null)),D=G(Y(B()));Le(()=>{const u=A("title")??null,g=A("volume")??null,L=A("chapter")??null,j=B();u!==e(q)&&u!==e(ee)&&a(q,u,!0),g!==e(U)&&g!==e(Q)&&a(U,g,!0),L!==e(O)&&L!==e(b)&&a(O,L,!0),j!==e(H)&&j!==e(D)&&a(H,j,!0)}),Le(()=>{e(q)!==e(ee)&&(t.editorState.updateChapterField(t.chapter.id,"title",e(q)),a(ee,e(q),!0))}),Le(()=>{e(U)!==e(Q)&&(t.editorState.updateChapterField(t.chapter.id,"volume",e(U)),a(Q,e(U),!0))}),Le(()=>{e(O)!==e(b)&&(t.editorState.updateChapterField(t.chapter.id,"chapter",e(O)),a(b,e(O),!0))}),Le(()=>{e(H)!==e(D)&&(t.editorState.updateChapterField(t.chapter.id,"language",e(H)),a(D,e(H),!0))});function h(){t.editorState.resetChapter(t.chapter.id);const u=t.chapter.original.title??null,g=t.chapter.original.volume??null,L=t.chapter.original.chapter??null,j=t.chapter.original.language;a(q,u,!0),a(U,g,!0),a(O,L,!0),a(H,j,!0),a(ee,u,!0),a(Q,g,!0),a(b,L,!0),a(D,j,!0)}async function _(){if(!d.apiToken){t.editorState.updateChapterSaveStatus(t.chapter.id,"error","No API token available");return}t.editorState.updateChapterSaveStatus(t.chapter.id,"saving");try{const u=t.editorState.getChapterUpdateData(t.chapter),g=await Rr(t.chapter.id,u,d.apiToken);t.editorState.updateChapterAfterSave(t.chapter.id,g),setTimeout(()=>{const L=t.editorState.chapters.find(j=>j.id===t.chapter.id);L&&L.saveStatus==="saved"&&!L.isModified&&t.editorState.updateChapterSaveStatus(t.chapter.id,"pending")},2e3)}catch(u){const g=u instanceof Error?u.message:"Failed to save chapter";t.editorState.updateChapterSaveStatus(t.chapter.id,"error",g)}}async function x(){if(!d.apiToken){t.editorState.updateChapterDeleteStatus(t.chapter.id,"error","No API token available");return}if(confirm(`Are you sure you want to delete chapter ${t.chapter.id}? This action cannot be undone.`)){t.editorState.updateChapterDeleteStatus(t.chapter.id,"deleting");try{await wr(t.chapter.id,d.apiToken),t.editorState.updateChapterDeleteStatus(t.chapter.id,"deleted"),setTimeout(()=>{t.editorState.removeChapter(t.chapter.id)},1e3)}catch(u){const g=u instanceof Error?u.message:"Failed to delete chapter";t.editorState.updateChapterDeleteStatus(t.chapter.id,"error",g)}}}var N=Aa(),T=o(N),V=o(T),se=o(V),ct=o(se);n(se);var Ge=i(se,2),Ve=o(Ge);n(Ge);var Ae=i(Ge,2);{var tt=u=>{var g=ha();l(u,g)};S(Ae,u=>{t.chapter.isModified&&u(tt)})}var he=i(Ae,2);{var rt=u=>{var g=fa();l(u,g)},vt=u=>{var g=te(),L=re(g);{var j=R=>{var X=ma();l(R,X)},ke=R=>{var X=te(),Ne=re(X);{var Ct=Fe=>{var ot=_a();l(Fe,ot)},He=Fe=>{var ot=te(),it=re(ot);{var _e=Pe=>{var lt=Sa();l(Pe,lt)},Je=Pe=>{var lt=te(),jt=re(lt);{var Qt=We=>{var pt=Ca();l(We,pt)},It=We=>{var pt=te(),Ut=re(pt);{var Zt=ut=>{var Rt=Ia();l(ut,Rt)};S(Ut,ut=>{t.chapter.saveStatus==="error"&&ut(Zt)},!0)}l(We,pt)};S(jt,We=>{t.chapter.saveStatus==="saved"?We(Qt):We(It,!1)},!0)}l(Pe,lt)};S(it,Pe=>{t.chapter.saveStatus==="saving"?Pe(_e):Pe(Je,!1)},!0)}l(Fe,ot)};S(Ne,Fe=>{t.chapter.deleteStatus==="error"?Fe(Ct):Fe(He,!1)},!0)}l(R,X)};S(L,R=>{t.chapter.deleteStatus==="deleted"?R(j):R(ke,!1)},!0)}l(u,g)};S(he,u=>{t.chapter.deleteStatus==="deleting"?u(rt):u(vt,!1)})}var ye=i(he,2),at=i(o(ye),2);nr(at,{textClass:"text-sm text-app",fieldName:"volume",get value(){return e(U)},set value(u){a(U,u,!0)}}),n(ye);var W=i(ye,2),ne=i(o(W),2);nr(ne,{textClass:"text-sm text-app",fieldName:"chapter",get value(){return e(O)},set value(u){a(O,u,!0)}}),n(W),n(V);var fe=i(V,2),$=o(fe);{var xt=u=>{var g=ba();g.__click=h,M(()=>g.disabled=t.chapter.saveStatus==="saving"||t.chapter.deleteStatus==="deleting"),l(u,g)};S($,u=>{t.chapter.isModified&&u(xt)})}var Be=i($,2);Be.__click=_;var xe=o(Be);{var st=u=>{var g=ue("Saving...");l(u,g)},Et=u=>{var g=te(),L=re(g);{var j=R=>{var X=ue("Saved");l(R,X)},ke=R=>{var X=ue("Save");l(R,X)};S(L,R=>{t.chapter.saveStatus==="saved"?R(j):R(ke,!1)},!0)}l(u,g)};S(xe,u=>{t.chapter.saveStatus==="saving"?u(st):u(Et,!1)})}n(Be);var nt=i(Be,2);nt.__click=x;var Nt=o(nt);{var qe=u=>{var g=ue("Deleting...");l(u,g)},je=u=>{var g=te(),L=re(g);{var j=R=>{var X=ue("Deleted");l(R,X)},ke=R=>{var X=ue("Delete");l(R,X)};S(L,R=>{t.chapter.deleteStatus==="deleted"?R(j):R(ke,!1)},!0)}l(u,g)};S(Nt,u=>{t.chapter.deleteStatus==="deleting"?u(qe):u(je,!1)})}n(nt),n(fe),n(T);var Ke=i(T,2),St=i(o(Ke),2),Dt=o(St);nr(Dt,{textClass:"text-sm text-app font-medium",fieldName:"title",get value(){return e(q)},set value(u){a(q,u,!0)}}),n(St),n(Ke);var Ee=i(Ke,2),Oe=i(o(Ee),2);{let u=Pt(()=>yt.map(g=>g.id));ur(Oe,{get items(){return e(u)},getDisplayText:g=>{const L=yt.find(j=>j.id===g);return L?dr(L):g},class:"uno-6zz63e",get selectedItem(){return e(H)},set selectedItem(g){a(H,g,!0)}})}n(Ee);var Te=i(Ee,2),Qe=i(o(Te),2);Dr(Qe,{fieldName:"groups",get groups(){return e(c)},set groups(u){a(c,u,!0)}}),n(Te);var Ue=i(Te,2);{var me=u=>{var g=Ga(),L=o(g,!0);n(g),M(()=>z(L,t.chapter.error)),l(u,g)};S(Ue,u=>{t.chapter.error&&u(me)})}n(N),M(()=>{Er(N,1,`uno-nbs6j7 ${t.chapter.isModified?"uno-o2133m":"uno-hyivlq"} ${t.chapter.saveStatus==="saving"?"uno-bl96x2":""} ${s()??""}`),z(ct,`#${t.index+1}`),z(Ve,`ID: ${t.chapter.id??""}`),Be.disabled=!t.chapter.isModified||t.chapter.saveStatus==="saving"||t.chapter.deleteStatus==="deleting",nt.disabled=t.chapter.saveStatus==="saving"||t.chapter.deleteStatus==="deleting"||t.chapter.deleteStatus==="deleted"}),l(ce,N),qt()}lr(["click"]);var xa=y('<p class="uno-noy726"> </p>'),Ea=y('<div class="uno-pwf4xz"><div class="uno-evm2ed"><h3 class="uno-q72ify">Chapters <!></h3> <div class="uno-6fwta5"><!> <div class="uno-6fwta5"><span class="uno-qmkpzb">Filter by Language:</span> <!></div></div></div> <div class="uno-23f7cj"></div></div>');function Na(ce,t){Vt(t,!0);let s=Mt(t,"editorState",7),d=Pt(()=>s().getFilteredChapters());var I=Ea(),c=o(I),A=o(c),B=i(o(A));{var q=h=>{var _=ue();M(()=>z(_,`(${e(d).length??""} of ${s().chapters.length??""})`)),l(h,_)},U=h=>{var _=ue();M(()=>z(_,`(${s().chapters.length??""})`)),l(h,_)};S(B,h=>{s().selectedLanguageFilter!==At?h(q):h(U,!1)})}n(A);var O=i(A,2),H=o(O);{var ee=h=>{var _=xa(),x=o(_);n(_),M(N=>z(x,`${N??""} modified`),[()=>s().getModifiedChapters().length]),l(h,_)};S(H,h=>{s().getModifiedChapters().length>0&&h(ee)})}var Q=i(H,2),b=i(o(Q),2);{let h=Pt(()=>[At,...yt.map(_=>_.id)]);ur(b,{get items(){return e(h)},getDisplayText:_=>{if(_===At)return"All Languages";const x=yt.find(N=>N.id===_);return x?dr(x):_},class:"uno-hzydes",get selectedItem(){return s().selectedLanguageFilter},set selectedItem(_){s().selectedLanguageFilter=_}})}n(Q),n(O),n(c);var D=i(c,2);Bt(D,23,()=>e(d),h=>h.id,(h,_,x)=>{ya(h,{get index(){return e(x)},get chapter(){return e(_)},get editorState(){return s()},get availableGroups(){return t.availableGroups}})}),n(D),n(I),l(ce,I),qt()}var Da=y('<span class="uno-07yj5v svelte-1ln36r3"> </span>'),Ra=y('<p class="uno-8v6iry svelte-1ln36r3">Loading chapter data...</p>'),wa=y('<p class="uno-3jftni svelte-1ln36r3"> </p>'),La=y('<p class="uno-jhlw6i svelte-1ln36r3">No dumped chapter lookups available.</p>'),Oa=y('<span class="uno-we5q6p svelte-1ln36r3"> </span>'),Ta=y('<span class="uno-k235uq svelte-1ln36r3"> </span>'),ka=y('<span class="uno-cf9y7u svelte-1ln36r3">→ No match found</span>'),Fa=y('<li class="svelte-1ln36r3"><span class="uno-mh207y svelte-1ln36r3"> </span> <!></li>'),Pa=y('<div class="uno-drcsp4 svelte-1ln36r3"><p class="uno-syw3wp svelte-1ln36r3"> <!></p> <ul class="uno-a92fuv svelte-1ln36r3"></ul></div>'),Ma=y('<p class="uno-eupyuk svelte-1ln36r3"> </p>'),za=y('<li class="svelte-1ln36r3"> </li>'),Va=y('<div class="uno-drcsp4 svelte-1ln36r3"><p class="uno-1fo7jt svelte-1ln36r3"> </p> <ul class="uno-q4h1v1 svelte-1ln36r3"></ul></div>'),qa=y('<div class="uno-47pxnt svelte-1ln36r3"><button type="button" class="uno-xb9urp svelte-1ln36r3">Apply Groups to Chapters</button> <button type="button" class="uno-vygkkt svelte-1ln36r3">Assign Titles to Chapters</button> <button type="button" class="uno-2lgh09 svelte-1ln36r3">Fix Missing Groups</button></div>'),ja=y('<p class="uno-v610wo svelte-1ln36r3">Applying groups to chapters... <!></p>'),Ua=y('<p class="uno-v610wo svelte-1ln36r3">Assigning titles to chapters... <!></p>'),Ha=y('<p class="uno-v610wo svelte-1ln36r3">Fixing missing groups... <!></p>'),Ja=y('<p class="uno-ovi0sm svelte-1ln36r3"> </p>'),Wa=y('<p class="uno-ovi0sm svelte-1ln36r3"> </p>'),Xa=y('<li class="svelte-1ln36r3"><span class="uno-mh207y svelte-1ln36r3"> </span> <span class="uno-2ve4eu svelte-1ln36r3">(<!>)</span></li>'),Ya=y('<div class="uno-drcsp4 svelte-1ln36r3"><p class="uno-1fo7jt svelte-1ln36r3"> </p> <ul class="uno-cwbkfr svelte-1ln36r3"></ul></div>'),Ba=y('<div class="uno-sve4ke svelte-1ln36r3"><p class="uno-v6fon0 svelte-1ln36r3"> </p> <!> <!> <!> <!> <!> <!> <!></div>'),Ka=y('<div class="uno-zrkrqo svelte-1ln36r3"><div class="uno-whtoz0 svelte-1ln36r3"><h3 class="uno-yuozvl svelte-1ln36r3">Chapter Dump Lookup</h3> <!></div> <!> <form class="uno-nypp1l svelte-1ln36r3"><div class="uno-r9zule svelte-1ln36r3"><p class="uno-83dpzr svelte-1ln36r3">Extract Volume from Title (Regex):</p> <input type="text" placeholder="Vol\\\\.? ?(\\\\d+)" class="uno-rtdrcq svelte-1ln36r3"/></div> <div class="uno-q5h8w1 svelte-1ln36r3"><label class="uno-qo6ajo svelte-1ln36r3"><input type="checkbox" class="uno-k04mdc svelte-1ln36r3"/> <span class="uno-8v6iry svelte-1ln36r3">Case Sensitive</span></label> <!> <button type="submit" class="uno-emxelj svelte-1ln36r3">Apply</button></div></form> <form class="uno-zn8ifb svelte-1ln36r3"><div class="uno-r9zule svelte-1ln36r3"><p class="uno-83dpzr svelte-1ln36r3">Extract Chapter Number from Title (Regex):</p> <input type="text" placeholder="(?:Ch\\\\.?|Chapter) ?(\\\\d+(?:\\\\.\\\\d+)?)" class="uno-rtdrcq svelte-1ln36r3"/></div> <div class="uno-q5h8w1 svelte-1ln36r3"><label class="uno-qo6ajo svelte-1ln36r3"><input type="checkbox" class="uno-k04mdc svelte-1ln36r3"/> <span class="uno-8v6iry svelte-1ln36r3">Case Sensitive</span></label> <!> <button type="submit" class="uno-emxelj svelte-1ln36r3">Apply</button></div></form> <form class="uno-zn8ifb svelte-1ln36r3"><div class="uno-q5h8w1 svelte-1ln36r3"><p class="uno-83dpzr svelte-1ln36r3">Assign Volume to All Chapters:</p> <input type="text" placeholder="Volume number" class="uno-486g9a svelte-1ln36r3"/></div> <div class="uno-q5h8w1 svelte-1ln36r3"><!> <button type="submit" class="uno-emxelj svelte-1ln36r3">Apply</button></div></form> <form class="uno-zn8ifb svelte-1ln36r3"><div class="uno-q5h8w1 svelte-1ln36r3"><p class="uno-83dpzr svelte-1ln36r3">Assign Chapter Number to All Chapters:</p> <input type="text" placeholder="Chapter number" class="uno-486g9a svelte-1ln36r3"/></div> <div class="uno-q5h8w1 svelte-1ln36r3"><!> <button type="submit" class="uno-emxelj svelte-1ln36r3">Apply</button></div></form> <form class="uno-zn8ifb svelte-1ln36r3"><div class="uno-q5h8w1 svelte-1ln36r3"><p class="uno-83dpzr svelte-1ln36r3">Assign Title to All Chapters:</p> <input type="text" placeholder="Chapter title" class="uno-7r1c44 svelte-1ln36r3"/></div> <div class="uno-q5h8w1 svelte-1ln36r3"><!> <button type="submit" class="uno-emxelj svelte-1ln36r3">Apply</button></div></form> <form class="uno-zn8ifb svelte-1ln36r3"><div class="uno-k16sf9 svelte-1ln36r3"><p class="uno-83dpzr svelte-1ln36r3">Assign Groups to All Chapters:</p> <!></div> <div class="uno-q5h8w1 svelte-1ln36r3"><!> <button type="submit" class="uno-emxelj svelte-1ln36r3">Set Group(s)</button> <button type="button" class="uno-emxelj svelte-1ln36r3">Append Group(s)</button></div></form> <form class="uno-zn8ifb svelte-1ln36r3"><div class="uno-q5h8w1 svelte-1ln36r3"><p class="uno-83dpzr svelte-1ln36r3">Assign Language to All Chapters:</p> <!></div> <div class="uno-q5h8w1 svelte-1ln36r3"><!> <button type="submit" class="uno-emxelj svelte-1ln36r3">Apply</button></div></form></div>');function Qa(ce,t){Vt(t,!0);var s=(r=>(r.IDLE="IDLE",r.LOADING="LOADING",r.LOADED="LOADED",r.ERROR="ERROR",r.APPLYING_GROUPS="APPLYING_GROUPS",r.ASSIGNING_TITLES="ASSIGNING_TITLES",r.FIXING_MISSING_GROUPS="FIXING_MISSING_GROUPS",r))(s||{});let d=Mt(t,"availableGroups",27,()=>Y([]));if(!Kt(zt))throw new Error("ChapterEditorBatchEdit must be used within a component that provides ApiAuthContext context");let c=G("IDLE"),A=G(0),B=G(0),q=G(Y([])),U=G(null),O=G(0),H=G(Y([])),ee=G(null),Q=G(0),b=G(0),D=G(null),h=G(null),_=G(null),x=G(0),N=G("en");const T=Y({start:null,end:null});let V=G(null);const se=Y({start:null,end:null});let ct=G(null);const Ge=Y({start:null,end:null});let Ve=G(null);const Ae=Y({start:null,end:null});let tt=G(Y(new Nr));const he=Y({start:null,end:null});let rt=G("Vol\\.? ?(\\d+)"),vt=G(!1);const ye=Y({start:null,end:null});let at=G("(?:Ch\\.?|Chapter) ?(\\d+(?:\\.\\d+)?)"),W=G(!1);const ne=Y({start:null,end:null});let fe=G(Y([])),$=Pt(()=>t.editorState.getFilteredChapters());Le(()=>{(async()=>{const r=t.editorState.seriesId,f=t.editorState.processingStep;if(r){const E=r!==e(ee);E&&e(ee)!==null&&(a(c,"IDLE"),a(A,0),a(B,0),a(q,[],!0),a(U,null),a(O,0),a(H,[],!0),a(Q,0),a(b,0),a(x,0),a(fe,[],!0),a(D,null),a(h,null),a(_,null)),E&&e(c)!=="LOADING"&&(f===Se.LOADED||f===Se.ERROR)&&await Be()}else e(ee)!==null&&xt()})()});function xt(){a(c,"IDLE"),a(A,0),a(B,0),a(q,[],!0),a(U,null),a(O,0),a(H,[],!0),a(ee,null),a(Q,0),a(b,0),a(x,0),a(fe,[],!0),a(D,null),a(h,null),a(_,null)}async function Be(){const r=t.editorState.seriesId;if(r)try{if(!await xe())return;if(!t.editorState.seriesId||t.editorState.seriesId!==r){a(c,"IDLE");return}await st(),a(c,"LOADED"),a(ee,r,!0)}catch(f){a(c,"ERROR"),a(U,f instanceof Error?f.message:"Failed to load chapter data",!0),console.error("Error in processing pipeline:",f)}}async function xe(){a(c,"LOADING"),a(U,null),a(A,0),a(B,0),a(q,[],!0),a(O,0),a(H,[],!0),a(Q,0),a(b,0),a(fe,[],!0);const r=t.editorState.seriesId;if(!r)return a(c,"IDLE"),!1;if(await dt.load(),!await dt.hasSeriesEntries(r))return a(ee,r,!0),a(c,"IDLE"),!1;const E=await dt.getAllGroupNames(r),m=await dt.getUniqueVolumeChapterCombinations(r);return a(A,E.length,!0),a(q,E.map(p=>({detectedName:p,matchedGroup:null})),!0),a(B,m.length,!0),!0}async function st(){const r=t.editorState.seriesId;if(!r)return;if(!await dt.hasSeriesEntries(r)){console.warn("No entries found in chapter dump for this series");return}const E=await dt.getAllGroupNames(r);if(E.length===0){console.log("No groups found in chapter dump, but series has entries (likely all ungrouped)");return}const m=await ta(E,ra,d().map(v=>({groupName:v.groupName}))),p=new Map;for(const v of m.successful)p.set(v.name,v);for(const v of E)if(!p.has(v)){const C=d().find(w=>w.groupName===v);C&&C.groupId&&p.set(v,{id:C.groupId,name:C.groupName})}a(q,E.map(v=>({detectedName:v,matchedGroup:p.get(v)??null})),!0);for(const v of m.successful)if(!d().find(w=>w.groupName===v.name)){const w=new Lr;w.groupId=v.id,w.groupName=v.name,d().push(w)}a(H,m.failed,!0),a(O,m.successful.length,!0)}async function Et(){if(e(c)!=="LOADED"||!t.editorState.seriesId)return;a(c,"APPLYING_GROUPS");let r=0;const f=t.editorState.chapters.filter(m=>(m.modified.language!==void 0?m.modified.language:m.original.language)==="en"),E=f.length;a(D,{current:0,total:E},!0);try{const m=aa.createGroupIdToNameMap(d());for(let p=0;p<f.length;p++){const v=f[p];a(D,{current:p+1,total:E},!0);const C=v.original,w=C.relationships?.groups,J=w&&Array.isArray(w)?w.map(Re=>Re.id):[],k=v.modified.groups??J,ae=k.map(Re=>m.get(Re)).filter(Re=>Re!==void 0),K=v.modified.title??C.title??null,Ce=K===""?null:K??null,Ie=v.modified.volume??C.volume??null,De={chapterVolume:Ie===""?null:Ie??null,chapterNumber:C.chapter,originalFolderPath:null,groupIds:k,currentTitle:Ce,language:C.language},Xe=await ir.lookupChapterRelease(De,t.editorState.seriesId,ae,{useFallbackMatching:!0});if(!Xe)continue;const Wt=await ir.getAllGroupIdsForRelease(t.editorState.seriesId,Xe.release,d());if(Wt.length===0)continue;const wt=new Set(k),Lt=[];for(const Re of Wt)wt.has(Re)||(Lt.push(Re),wt.add(Re));Lt.length>0&&(t.editorState.updateChapterField(v.id,"groups",[...k,...Lt]),r++)}a(Q,r,!0),a(D,null),a(c,"LOADED")}catch(m){a(D,null),a(c,"ERROR"),a(U,m instanceof Error?m.message:"Failed to apply groups to chapters",!0),console.error("Error applying groups to chapters:",m)}}async function nt(){if(e(c)!=="LOADED"||!t.editorState.seriesId)return;a(c,"FIXING_MISSING_GROUPS");let r=0;const E=t.editorState.chapters.filter(p=>(p.modified.language??p.original.language)==="en").filter(p=>{const C=p.original.relationships?.groups,w=C&&Array.isArray(C)?C.map(k=>k.id):[];return(p.modified.groups??w).length===0}),m=E.length;a(_,{current:0,total:m},!0);try{for(let p=0;p<E.length;p++){const v=E[p];a(_,{current:p+1,total:m},!0);const C=v.original,w=v.modified.volume??C.volume??null,J=w===""?null:w??null,k=C.chapter,ae=v.modified.language??C.language;let K=null,Ce=J;if(J!==null&&k!==null&&(K=await dt.getUniqueChapterInfo(t.editorState.seriesId,J,k,ae)),!K&&k!==null){const ge=await dt.getUniqueChapterInfoByChapter(t.editorState.seriesId,k,ae);ge&&(K=ge.info,Ce=ge.volume)}if(!K)continue;const Ie=await ir.getAllGroupIdsForRelease(t.editorState.seriesId,K,d());Ie.length!==0&&(t.editorState.updateChapterField(v.id,"groups",Ie),Ce!==null&&Ce!==J&&t.editorState.updateChapterField(v.id,"volume",Ce),r++)}a(x,r,!0),a(_,null),a(c,"LOADED")}catch(p){a(_,null),a(c,"ERROR"),a(U,p instanceof Error?p.message:"Failed to fix missing groups",!0),console.error("Error fixing missing groups:",p)}}async function Nt(){if(e(c)!=="LOADED"||!t.editorState.seriesId)return;a(c,"ASSIGNING_TITLES");const r=[],f=t.editorState.chapters.filter(m=>(m.modified.language??m.original.language)==="en"),E=f.length;a(h,{current:0,total:E},!0);try{const m=new Map,p=[];for(const C of f){const w=C.original,J=w.relationships?.groups,k=J&&Array.isArray(J)?J.map(Xe=>Xe.id):[],ae=C.modified.groups??k,K=C.modified.title??w.title??null,Ce=K===""?null:K??null,Ie=C.modified.volume??w.volume??null,De={chapterVolume:Ie===""?null:Ie??null,chapterNumber:w.chapter,originalFolderPath:null,groupIds:ae,currentTitle:Ce,language:w.language};p.push(De),m.set(De,C)}const v=await sa.applyChangesFromDump(p,d(),t.editorState.seriesId,{useFallbackMatching:!0,isNoGroupChapter:()=>!1});for(let C=0;C<v.results.length;C++){a(h,{current:C+1,total:E},!0);const w=v.results[C],J=p[C],k=m.get(J);if(k)if((w.status===Ar.SUCCESS||w.status===Ar.NO_CHANGES)&&w.changes){const{volume:ae,title:K,additionalGroupIds:Ce}=w.changes,Ie=k.original;if(K!==void 0){const ge=K===null||K===""?null:K,De=Ie.title??null;ge!==De&&t.editorState.updateChapterField(k.id,"title",ge)}if(ae!==void 0){const ge=Ie.volume??null;ae!==ge&&t.editorState.updateChapterField(k.id,"volume",ae)}if(Ce.length>0){const De=[...k.modified.groups??k.original.relationships?.groups?.map(Xe=>Xe.id)??[],...Ce];t.editorState.updateChapterField(k.id,"groups",De)}}else{const ae=k.original,K=w.warnings.length>0?w.warnings[0].reason:Ft.NO_CHAPTER_INFO;r.push({volume:J.chapterVolume,chapter:J.chapterNumber,chapterId:ae.id,reason:K})}}a(b,v.successCount,!0),a(fe,r,!0),a(h,null),a(c,"LOADED")}catch(m){a(h,null),a(c,"ERROR"),a(U,m instanceof Error?m.message:"Failed to assign titles to chapters",!0),console.error("Error assigning titles to chapters:",m)}}function qe(){const r=e($),f=(T.start??1)-1,E=(T.end??r.length)-1,m=e(N)?.trim()||"en";for(let p=f;p<=E;p++){const v=r[p];t.editorState.updateChapterField(v.id,"language",m)}}function je(){const r=e($),f=(se.start??1)-1,E=(se.end??r.length)-1,m=e(V)===void 0||e(V)===null||e(V)===""?null:e(V).trim()||null;for(let p=f;p<=E;p++){const v=r[p],C=v.original.volume??null;m!==C&&t.editorState.updateChapterField(v.id,"volume",m)}}function Ke(){const r=e($),f=(Ge.start??1)-1,E=(Ge.end??r.length)-1,m=e(ct)?.trim()||null;for(let p=f;p<=E;p++){const v=r[p];t.editorState.updateChapterField(v.id,"chapter",m)}}function St(){const r=e($),f=(Ae.start??1)-1,E=(Ae.end??r.length)-1,m=e(Ve)===void 0||e(Ve)===null||e(Ve)===""?null:e(Ve).trim()||null;for(let p=f;p<=E;p++){const v=r[p],C=v.original.title??null;m!==C&&t.editorState.updateChapterField(v.id,"title",m)}}function Dt(){const r=e($),f=(he.start??1)-1,E=(he.end??r.length)-1,m=e(tt).groupIds??[];for(let p=f;p<=E;p++){const v=r[p];t.editorState.updateChapterField(v.id,"groups",[...m])}}function Ee(){const r=e($),f=(he.start??1)-1,E=(he.end??r.length)-1,m=e(tt).groupIds??[];for(let p=f;p<=E;p++){const v=r[p],w=[...v.modified.groups??v.original.relationships?.groups?.map(k=>k.id)??[],...m],J=[...new Set(w)];t.editorState.updateChapterField(v.id,"groups",J)}}function Oe(r){const f=r.modified.title??r.original.title??null;return f===""?"":f??""}function Te(){if(!e(rt).trim())return;const r=e($),f=e(vt)?"":"i",E=new RegExp(e(rt),f),m=(ye.start??1)-1,p=(ye.end??r.length)-1;for(let v=m;v<=p;v++){const C=r[v],J=Oe(C).match(E);if(J&&J[1]){const k=J[1].replace(/^0+/,"");t.editorState.updateChapterField(C.id,"volume",k)}}}function Qe(){if(!e(at).trim())return;const r=e($),f=e(W)?"":"i",E=new RegExp(e(at),f),m=(ne.start??1)-1,p=(ne.end??r.length)-1;for(let v=m;v<=p;v++){const C=r[v],J=Oe(C).match(E);if(J&&J[1]){const k=J[1].replace(/^0+/,"");t.editorState.updateChapterField(C.id,"chapter",k)}}}var Ue=Ka(),me=o(Ue),u=i(o(me),2);{var g=r=>{var f=Da(),E=o(f);n(f),M(()=>z(E,`(${e($).length??""} of ${t.editorState.chapters.length??""} chapters shown)`)),l(r,f)};S(u,r=>{t.editorState.selectedLanguageFilter!==At&&r(g)})}n(me);var L=i(me,2);{var j=r=>{var f=Ra();l(r,f)},ke=r=>{var f=te(),E=re(f);{var m=v=>{var C=wa(),w=o(C,!0);n(C),M(()=>z(w,e(U))),l(v,C)},p=v=>{var C=te(),w=re(C);{var J=ae=>{var K=La();l(ae,K)},k=ae=>{var K=te(),Ce=re(K);{var Ie=ge=>{var De=Ba(),Xe=o(De),Wt=o(Xe);n(Xe);var wt=i(Xe,2);{var Lt=F=>{var P=Pa(),Z=o(P),Me=o(Z),ze=i(Me);{var we=de=>{var ie=Oa(),be=o(ie);n(ie),M(()=>z(be,`(${e(O)??""}
								${e(O)===1?"group":"groups"} added)`)),l(de,ie)};S(ze,de=>{e(O)>0&&de(we)})}n(Z);var oe=i(Z,2);Bt(oe,21,()=>e(q),or,(de,ie)=>{var be=Fa(),ve=o(be),Ye=o(ve,!0);n(ve);var gt=i(ve,2);{var ht=le=>{var Ze=Ta(),Ot=o(Ze);n(Ze),M(()=>z(Ot,`→ ${e(ie).matchedGroup.name??""} (ID: ${e(ie).matchedGroup.id??""})`)),l(le,Ze)},pe=le=>{var Ze=ka();l(le,Ze)};S(gt,le=>{e(ie).matchedGroup?le(ht):le(pe,!1)})}n(be),M(()=>z(Ye,e(ie).detectedName)),l(de,be)}),n(oe),n(P),M(()=>z(Me,`Detected Groups (${e(q).length??""}): `)),l(F,P)};S(wt,F=>{e(q).length>0&&F(Lt)})}var Re=i(wt,2);{var zr=F=>{var P=Ma(),Z=o(P);n(P),M(()=>z(Z,`Added ${e(O)??""}
					${e(O)===1?"group":"groups"} to available scan groups.`)),l(F,P)};S(Re,F=>{e(O)>0&&e(q).length===0&&F(zr)})}var _r=i(Re,2);{var Vr=F=>{var P=Va(),Z=o(P),Me=o(Z);n(Z);var ze=i(Z,2);Bt(ze,21,()=>e(H),or,(we,oe)=>{var de=za(),ie=o(de,!0);n(de),M(()=>z(ie,e(oe))),l(we,de)}),n(ze),n(P),M(()=>z(Me,`Warning: Failed to lookup ${e(H).length??""} 
						${e(H).length===1?"group":"groups"}:`)),l(F,P)};S(_r,F=>{e(H).length>0&&F(Vr)})}var Sr=i(_r,2);{var qr=F=>{var P=qa(),Z=o(P);Z.__click=Et;var Me=i(Z,2);Me.__click=Nt;var ze=i(Me,2);ze.__click=nt,n(P),l(F,P)},jr=F=>{var P=te(),Z=re(P);{var Me=we=>{var oe=ja(),de=i(o(oe));{var ie=be=>{var ve=ue();M(()=>z(ve,`(${e(D).current??""} / ${e(D).total??""})`)),l(be,ve)};S(de,be=>{e(D)&&be(ie)})}n(oe),l(we,oe)},ze=we=>{var oe=te(),de=re(oe);{var ie=ve=>{var Ye=Ua(),gt=i(o(Ye));{var ht=pe=>{var le=ue();M(()=>z(le,`(${e(h).current??""} / ${e(h).total??""})`)),l(pe,le)};S(gt,pe=>{e(h)&&pe(ht)})}n(Ye),l(ve,Ye)},be=ve=>{var Ye=te(),gt=re(Ye);{var ht=pe=>{var le=Ha(),Ze=i(o(le));{var Ot=Tt=>{var $e=ue();M(()=>z($e,`(${e(_).current??""} / ${e(_).total??""})`)),l(Tt,$e)};S(Ze,Tt=>{e(_)&&Tt(Ot)})}n(le),l(pe,le)};S(gt,pe=>{e(c)===s.FIXING_MISSING_GROUPS&&pe(ht)},!0)}l(ve,Ye)};S(de,ve=>{e(c)===s.ASSIGNING_TITLES?ve(ie):ve(be,!1)},!0)}l(we,oe)};S(Z,we=>{e(c)===s.APPLYING_GROUPS?we(Me):we(ze,!1)},!0)}l(F,P)};S(Sr,F=>{e(c)===s.LOADED?F(qr):F(jr,!1)})}var Cr=i(Sr,2);{var Ur=F=>{var P=Ja(),Z=o(P);n(P),M(()=>z(Z,`Applied ${e(Q)??""}
					${e(Q)===1?"group":"groups"} to chapters.`)),l(F,P)};S(Cr,F=>{e(Q)>0&&F(Ur)})}var Ir=i(Cr,2);{var Hr=F=>{var P=Wa(),Z=o(P);n(P),M(()=>z(Z,`Assigned ${e(b)??""}
					${e(b)===1?"title":"titles"} to chapters.`)),l(F,P)};S(Ir,F=>{e(b)>0&&F(Hr)})}var Jr=i(Ir,2);{var Wr=F=>{var P=Ya(),Z=o(P),Me=o(Z);n(Z);var ze=i(Z,2);Bt(ze,21,()=>e(fe),or,(we,oe)=>{var de=Xa(),ie=o(de),be=o(ie);n(ie);var ve=i(ie,2),Ye=i(o(ve));{var gt=pe=>{var le=ue("No groups assigned");l(pe,le)},ht=pe=>{var le=te(),Ze=re(le);{var Ot=$e=>{var Xt=ue("No valid groups found");l($e,Xt)},Tt=$e=>{var Xt=te(),Xr=re(Xt);{var Yr=bt=>{var Yt=ue("No matching volume/chapter in export");l(bt,Yt)},Br=bt=>{var Yt=te(),Kr=re(Yt);{var Qr=Gt=>{var ar=ue("No matching group in export");l(Gt,ar)},Zr=Gt=>{var ar=ue("Failed to match");l(Gt,ar)};S(Kr,Gt=>{e(oe).reason===Ft.NO_MATCHING_GROUP?Gt(Qr):Gt(Zr,!1)},!0)}l(bt,Yt)};S(Xr,bt=>{e(oe).reason===Ft.NO_CHAPTER_INFO?bt(Yr):bt(Br,!1)},!0)}l($e,Xt)};S(Ze,$e=>{e(oe).reason===Ft.NO_VALID_GROUPS?$e(Ot):$e(Tt,!1)},!0)}l(pe,le)};S(Ye,pe=>{e(oe).reason===Ft.NO_GROUPS?pe(gt):pe(ht,!1)})}et(),n(ve),n(de),M(()=>z(be,`Vol ${e(oe).volume??"N/A"??""}, Ch ${e(oe).chapter??"N/A"??""}`)),l(we,de)}),n(ze),n(P),M(()=>z(Me,`Warning: Unable to assign titles to ${e(fe).length??""} 
						${e(fe).length===1?"chapter":"chapters"} (volume and chapter must match
						exactly):`)),l(F,P)};S(Jr,F=>{e(fe).length>0&&F(Wr)})}n(De),M(()=>z(Wt,`Found ${e(A)??""}
				${e(A)===1?"group":"groups"} and ${e(B)??""}
				${e(B)===1?"chapter":"chapters"} in chapter dump.`)),l(ge,De)};S(Ce,ge=>{(e(c)===s.LOADED||e(c)===s.APPLYING_GROUPS||e(c)===s.ASSIGNING_TITLES||e(c)===s.FIXING_MISSING_GROUPS)&&ge(Ie)},!0)}l(ae,K)};S(w,ae=>{e(c)===s.IDLE?ae(J):ae(k,!1)},!0)}l(v,C)};S(E,v=>{e(c)===s.ERROR?v(m):v(p,!1)},!0)}l(r,f)};S(L,r=>{e(c)===s.LOADING?r(j):r(ke,!1)})}var R=i(L,2),X=o(R),Ne=i(o(X),2);mt(Ne),n(X);var Ct=i(X,2),He=o(Ct),Fe=o(He);mt(Fe),et(2),n(He);var ot=i(He,2);_t(ot,{min:1,get max(){return e($).length},get rangeStart(){return ye.start},set rangeStart(r){ye.start=r},get rangeEnd(){return ye.end},set rangeEnd(r){ye.end=r}}),et(2),n(Ct),n(R);var it=i(R,2),_e=o(it),Je=i(o(_e),2);mt(Je),n(_e);var Pe=i(_e,2),lt=o(Pe),jt=o(lt);mt(jt),et(2),n(lt);var Qt=i(lt,2);_t(Qt,{min:1,get max(){return e($).length},get rangeStart(){return ne.start},set rangeStart(r){ne.start=r},get rangeEnd(){return ne.end},set rangeEnd(r){ne.end=r}}),et(2),n(Pe),n(it);var It=i(it,2),We=o(It),pt=i(o(We),2);mt(pt),n(We);var Ut=i(We,2),Zt=o(Ut);_t(Zt,{min:1,get max(){return e($).length},get rangeStart(){return se.start},set rangeStart(r){se.start=r},get rangeEnd(){return se.end},set rangeEnd(r){se.end=r}}),et(2),n(Ut),n(It);var ut=i(It,2),Rt=o(ut),cr=i(o(Rt),2);mt(cr),n(Rt);var vr=i(Rt,2),Or=o(vr);_t(Or,{min:1,get max(){return e($).length},get rangeStart(){return Ge.start},set rangeStart(r){Ge.start=r},get rangeEnd(){return Ge.end},set rangeEnd(r){Ge.end=r}}),et(2),n(vr),n(ut);var Ht=i(ut,2),$t=o(Ht),pr=i(o($t),2);mt(pr),n($t);var gr=i($t,2),Tr=o(gr);_t(Tr,{min:1,get max(){return e($).length},get rangeStart(){return Ae.start},set rangeStart(r){Ae.start=r},get rangeEnd(){return Ae.end},set rangeEnd(r){Ae.end=r}}),et(2),n(gr),n(Ht);var Jt=i(Ht,2),er=o(Jt),kr=i(o(er),2);Dr(kr,{get groups(){return e(tt)},set groups(r){a(tt,r,!0)}}),n(er);var hr=i(er,2),fr=o(hr);_t(fr,{min:1,get max(){return e($).length},get rangeStart(){return he.start},set rangeStart(r){he.start=r},get rangeEnd(){return he.end},set rangeEnd(r){he.end=r}});var Fr=i(fr,4);Fr.__click=Ee,n(hr),n(Jt);var tr=i(Jt,2),rr=o(tr),Pr=i(o(rr),2);{let r=Pt(()=>yt.map(f=>f.id));ur(Pr,{get items(){return e(r)},getDisplayText:f=>{const E=yt.find(m=>m.id===f);return E?dr(E):f},class:"uno-ggujl7",get selectedItem(){return e(N)},set selectedItem(f){a(N,f,!0)}})}n(rr);var mr=i(rr,2),Mr=o(mr);_t(Mr,{min:1,get max(){return e($).length},get rangeStart(){return T.start},set rangeStart(r){T.start=r},get rangeEnd(){return T.end},set rangeEnd(r){T.end=r}}),et(2),n(mr),n(tr),n(Ue),ft("submit",R,r=>{Te(),r.preventDefault()}),kt(Ne,()=>e(rt),r=>a(rt,r)),Gr(Fe,()=>e(vt),r=>a(vt,r)),ft("submit",it,r=>{Qe(),r.preventDefault()}),kt(Je,()=>e(at),r=>a(at,r)),Gr(jt,()=>e(W),r=>a(W,r)),ft("submit",It,r=>{je(),r.preventDefault()}),kt(pt,()=>e(V),r=>a(V,r)),ft("submit",ut,r=>{Ke(),r.preventDefault()}),kt(cr,()=>e(ct),r=>a(ct,r)),ft("submit",Ht,r=>{St(),r.preventDefault()}),kt(pr,()=>e(Ve),r=>a(Ve,r)),ft("submit",Jt,r=>{Dt(),r.preventDefault()}),ft("submit",tr,r=>{qe(),r.preventDefault()}),l(ce,Ue),qt()}lr(["click"]);function Za(ce,t){Vt(t,!0);let s=Mt(t,"editorState",7),d=Mt(t,"availableGroups",31,()=>Y([]));const I=Kt(zt);if(!I)throw new Error("ChapterEditorProcessor must be used within a component that provides ApiAuthContext context");let c=G(null),A=G(!1);function B(b){if(s().permissionOverride)return!0;if(!I.userIdentity)return!1;const D=I.userIdentity.id;if(b.relationships?.uploader?.id===D)return!0;const h=b.relationships?.groups;if(!h||!Array.isArray(h))return!1;const _=new Set(h.map(x=>x.id));if(!I.userGroups||!Array.isArray(I.userGroups))return!1;for(const x of I.userGroups)if(_.has(x.id)){const N=x.relationships?.members;if(!N||!Array.isArray(N))continue;const T=N.find(V=>V.id===D);if(T&&(T.is_leader||T.is_officer))return!0}return!1}Le(()=>{(async()=>{const b=s().seriesId,D=I.apiToken;I.userIdentity;const h=s().permissionOverride;if(!b||!D){e(c)!==null&&(s().chapters=[],s().filteredChaptersCount=0,s().processingStep=Se.IDLE,a(c,null));return}const _=b!==e(c),x=h!==e(A);(_||x||e(c)===null)&&(await q(),a(A,h,!0))})()});async function q(){if(!(!s().seriesId||!I.apiToken)){s().processingStep=Se.LOADING,s().loadError=null;try{const b=await na(s().seriesId),D=b.length,h=b.filter(T=>B(T));s().permissionOverride?s().filteredChaptersCount=0:s().filteredChaptersCount=D-h.length;const _=h.map(T=>({id:T.id,original:T,modified:{},isModified:!1,saveStatus:"pending",error:void 0}));s().chapters=_;const x=s().permissionOverride?b:h,N=new Map;for(const T of x)if(T?.relationships?.groups&&Array.isArray(T.relationships.groups)){for(const V of T.relationships.groups)if(V?.id&&V?.name&&!N.has(V.id)){const se=new Lr;se.groupId=V.id,se.groupName=V.name,N.set(V.id,se)}}d(Array.from(N.values())),s().processingStep=Se.LOADED,a(c,s().seriesId,!0),a(A,s().permissionOverride,!0)}catch(b){s().processingStep=Se.ERROR,s().loadError=b instanceof Error?b.message:"Failed to load chapters",console.error("Error loading chapters:",b)}}}async function U(){if(!I.apiToken){alert("No API token available");return}const b=s().getModifiedChapters();if(b.length===0){alert("No modified chapters to save");return}s().processingStep=Se.SAVING,s().isSavingAll=!0,s().saveProgress={current:0,total:b.length};let D=0,h=0;for(let _=0;_<b.length;_++){const x=b[_];s().saveProgress={current:_+1,total:b.length};try{const N=s().getChapterUpdateData(x);console.log("Saving chapter:",x.id),console.log("Update data:",N);const T=await Rr(x.id,N,I.apiToken);x.original=T,x.modified={},x.isModified=!1,x.saveStatus="saved",x.error=void 0,D++}catch(N){x.saveStatus="error",x.error=N instanceof Error?N.message:"Failed to save chapter",h++}}s().isSavingAll=!1,s().saveProgress=null,s().processingStep=Se.LOADED,h>0?alert(`Saved ${D} chapters. ${h} failed. Check individual chapters for errors.`):alert(`Successfully saved ${D} chapters.`)}function O(){const b=s().getModifiedChapters();for(const D of b)s().resetChapter(D.id)}function H(){a(c,null),a(A,!s().permissionOverride)}async function ee(b){if(!I.apiToken){alert("No API token available");return}if(b.length===0){alert("No chapters selected for deletion");return}if(!confirm(`Are you sure you want to delete ${b.length} chapter(s)? This action cannot be undone.`))return;s().processingStep=Se.SAVING,s().isSavingAll=!0,s().saveProgress={current:0,total:b.length};let D=0,h=0;const _=[];for(let x=0;x<b.length;x++){const N=b[x];if(s().saveProgress={current:x+1,total:b.length},!s().chapters.find(V=>V.id===N)){h++;continue}try{s().updateChapterDeleteStatus(N,"deleting"),await wr(N,I.apiToken),s().updateChapterDeleteStatus(N,"deleted"),_.push(N),D++}catch(V){s().updateChapterDeleteStatus(N,"error",V instanceof Error?V.message:"Failed to delete chapter"),h++}}for(const x of _)s().removeChapter(x);s().isSavingAll=!1,s().saveProgress=null,s().processingStep=Se.LOADED,h>0?alert(`Deleted ${D} chapters. ${h} failed. Check individual chapters for errors.`):alert(`Successfully deleted ${D} chapters.`)}var Q={saveAllModified:U,revertAllModified:O,reloadChapters:H,deleteAllSelected:ee};return qt(Q)}var $a=xr('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>'),es=xr('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>'),ts=y('<p class="uno-rvflv7">Loading chapters...</p>'),rs=y('<p class="uno-chd4ub"> </p>'),as=y('<span class="uno-0kvlub">All chapters visible (override enabled)</span>'),ss=y('<p class="uno-zir0it"> </p>'),ns=y('<div class="uno-7bik28"><button type="button" class="uno-gkei3v"> </button> <button type="button" class="uno-v6bita"><!></button></div>'),os=y('<div class="uno-wuf9ny"><div class="uno-a2k9zs"><div class="uno-dr6mtf"><h2 class="uno-alqayt">Chapters</h2> <!> <!></div> <!></div> <!></div>'),is=y('<div class="uno-wuf9ny"><p class="uno-94tecn">No accessible chapters found for this series.</p> <p class="uno-zir0it"> </p></div>'),ls=y('<p class="uno-94tecn">No chapters found for this series.</p>'),us=y('<div class="uno-js2hdc"><!> <!></div>'),ds=y('<p class="uno-94tecn">Please select a series to begin editing chapters.</p>'),cs=y('<div class="uno-91vis9"><div class="uno-7udnhq"><h1 class="uno-rgxfok">Chapter Mass Editor</h1> <div class="uno-7bik28"><button type="button" class="uno-546lus">Simple Mode</button> <button type="button" class="uno-546lus">Guided Mode</button> <!></div></div> <a target="_blank" class="uno-o7pvrl">Tutorial & Docs</a> <!> <!> <div class="uno-js2hdc"><div class="uno-wuf9ny"><div class="uno-a2k9zs"><h2 class="uno-alqayt">Series Selection</h2> <button type="button"><svg class="uno-t3x9d1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><!></svg> <span> </span></button></div> <!> <!></div> <!></div></div>');function As(ce,t){Vt(t,!0),br(zt,new va);const s=new oa;br(ca,s);const d=new ga,I=Kt(zt);let c=G(Y([])),A=G(null);Le(()=>{d.seriesId=s.seriesId}),Le(()=>{s.availableScanGroups=e(c)});function B(){e(A)&&e(A).saveAllModified()}function q(){e(A)&&e(A).revertAllModified()}var U=cs(),O=o(U),H=i(o(O),2),ee=o(H);ee.__click=()=>yr(sr("/"));var Q=i(ee,2);Q.__click=()=>yr(sr("/guided"));var b=i(Q,2);ia(b,{}),n(H),n(O);var D=i(O,2),h=i(D,2);la(h,{});var _=i(h,2);ea(Za(_,{get editorState(){return d},get availableGroups(){return e(c)},set availableGroups(W){a(c,W,!0)}}),W=>a(A,W,!0),()=>e(A));var x=i(_,2),N=o(x),T=o(N),V=i(o(T),2);V.__click=()=>{d.permissionOverride=!d.permissionOverride,e(A)&&e(A).reloadChapters()};var se=o(V),ct=o(se);{var Ge=W=>{var ne=$a();l(W,ne)},Ve=W=>{var ne=es();l(W,ne)};S(ct,W=>{d.permissionOverride?W(Ge):W(Ve,!1)})}n(se);var Ae=i(se,2),tt=o(Ae,!0);n(Ae),n(V),n(T);var he=i(T,2);ua(he,{});var rt=i(he,2);da(rt,{}),n(N);var vt=i(N,2);{var ye=W=>{var ne=us(),fe=o(ne);Qa(fe,{get editorState(){return d},get availableGroups(){return e(c)},set availableGroups(xe){a(c,xe,!0)}});var $=i(fe,2);{var xt=xe=>{var st=ts();l(xe,st)},Be=xe=>{var st=te(),Et=re(st);{var nt=qe=>{var je=rs(),Ke=o(je,!0);n(je),M(()=>z(Ke,d.loadError)),l(qe,je)},Nt=qe=>{var je=te(),Ke=re(je);{var St=Ee=>{var Oe=os(),Te=o(Oe),Qe=o(Te),Ue=i(o(Qe),2);{var me=R=>{var X=as();l(R,X)};S(Ue,R=>{d.permissionOverride&&R(me)})}var u=i(Ue,2);{var g=R=>{var X=ss(),Ne=o(X);n(X),M(()=>z(Ne,`${d.filteredChaptersCount??""}
										${d.filteredChaptersCount===1?"chapter":"chapters"} hidden due to
										insufficient permissions`)),l(R,X)};S(u,R=>{d.filteredChaptersCount>0&&!d.permissionOverride&&R(g)})}n(Qe);var L=i(Qe,2);{var j=R=>{var X=ns(),Ne=o(X);Ne.__click=q;var Ct=o(Ne);n(Ne);var He=i(Ne,2);He.__click=B;var Fe=o(He);{var ot=_e=>{var Je=ue();M(()=>z(Je,`Saving... (${d.saveProgress?.current??0??""} / ${d.saveProgress?.total??0??""})`)),l(_e,Je)},it=_e=>{var Je=ue();M(Pe=>z(Je,`Save All Modified (${Pe??""})`),[()=>d.getModifiedChapters().length]),l(_e,Je)};S(Fe,_e=>{d.isSavingAll?_e(ot):_e(it,!1)})}n(He),n(X),M(_e=>{Ne.disabled=d.isSavingAll,z(Ct,`Revert All (${_e??""})`),He.disabled=d.isSavingAll||!I.apiToken},[()=>d.getModifiedChapters().length]),l(R,X)};S(L,R=>{d.getModifiedChapters().length>0&&R(j)})}n(Te);var ke=i(Te,2);Na(ke,{get editorState(){return d},get availableGroups(){return e(c)}}),n(Oe),l(Ee,Oe)},Dt=Ee=>{var Oe=te(),Te=re(Oe);{var Qe=me=>{var u=is(),g=i(o(u),2),L=o(g);n(g),n(u),M(()=>z(L,`${d.filteredChaptersCount??""}
							${d.filteredChaptersCount===1?"chapter":"chapters"}
							${d.filteredChaptersCount===1?"was":"were"} filtered out due to insufficient
							permissions.`)),l(me,u)},Ue=me=>{var u=te(),g=re(u);{var L=j=>{var ke=ls();l(j,ke)};S(g,j=>{d.processingStep===Se.LOADED&&j(L)},!0)}l(me,u)};S(Te,me=>{d.filteredChaptersCount>0?me(Qe):me(Ue,!1)},!0)}l(Ee,Oe)};S(Ke,Ee=>{d.processingStep===Se.LOADED&&d.chapters.length>0?Ee(St):Ee(Dt,!1)},!0)}l(qe,je)};S(Et,qe=>{d.loadError?qe(nt):qe(Nt,!1)},!0)}l(xe,st)};S($,xe=>{d.processingStep===Se.LOADING?xe(xt):xe(Be,!1)})}n(ne),l(W,ne)},at=W=>{var ne=ds();l(W,ne)};S(vt,W=>{d.seriesId?W(ye):W(at,!1)})}n(x),n(U),M(W=>{$r(D,"href",W),Er(V,1,`uno-w46u2s ${d.permissionOverride?"uno-com2eg":"uno-17pzu5 hover:bg-surface-border border-surface-border"}`),z(tt,d.permissionOverride?"Override Enabled":"Override Permissions")},[()=>sr("/docs")]),l(ce,U),qt()}lr(["click"]);export{As as component,Gs as universal};
